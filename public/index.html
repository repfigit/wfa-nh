<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NH Childcare Payments Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #1a365d;
      --primary-light: #2c5282;
      --secondary: #718096;
      --success: #38a169;
      --warning: #d69e2e;
      --danger: #e53e3e;
      --critical: #9b2c2c;
      --bg: #f7fafc;
      --card-bg: #ffffff;
      --text: #2d3748;
      --text-light: #718096;
      --border: #e2e8f0;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }
    
    header {
      background: var(--primary);
      color: white;
      padding: 1rem 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    header h1 { font-size: 1.5rem; font-weight: 600; }
    header p { opacity: 0.9; font-size: 0.875rem; }
    
    .header-subtitle {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.25rem;
    }
    
    .header-badge {
      background: var(--danger);
      padding: 0.15rem 0.5rem;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    nav {
      background: var(--primary-light);
      padding: 0.5rem 2rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    nav a {
      color: white;
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      font-size: 0.875rem;
      transition: background 0.2s;
    }
    
    nav a:hover, nav a.active { background: rgba(255,255,255,0.2); }
    
    main { max-width: 1400px; margin: 0 auto; padding: 2rem; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background: var(--card-bg);
      padding: 1.25rem;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .stat-card h3 {
      font-size: 0.7rem;
      text-transform: uppercase;
      color: var(--text-light);
      margin-bottom: 0.5rem;
      letter-spacing: 0.5px;
    }
    
    .stat-card .value { font-size: 1.75rem; font-weight: 700; color: var(--primary); }
    .stat-card.warning .value { color: var(--warning); }
    .stat-card.danger .value { color: var(--danger); }
    .stat-card.highlight { border-left: 4px solid var(--danger); }
    
    .card {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
    }
    
    .card-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .card-header h2 { font-size: 1.125rem; font-weight: 600; }
    .card-body { padding: 1.5rem; }
    
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .chart-container { position: relative; height: 250px; }
    
    table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
    th, td { text-align: left; padding: 0.75rem; border-bottom: 1px solid var(--border); }
    th { font-size: 0.7rem; text-transform: uppercase; color: var(--text-light); font-weight: 600; }
    tr:hover { background: var(--bg); }
    
    .badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.7rem;
      font-weight: 500;
    }
    
    .badge-low { background: #c6f6d5; color: #276749; }
    .badge-medium { background: #fefcbf; color: #975a16; }
    .badge-high { background: #fed7d7; color: #c53030; }
    .badge-critical { background: #9b2c2c; color: white; }
    .badge-open { background: #bee3f8; color: #2c5282; }
    .badge-investigating { background: #fefcbf; color: #975a16; }
    .badge-resolved { background: #c6f6d5; color: #276749; }
    .badge-dismissed { background: #e2e8f0; color: #4a5568; }
    .badge-immigrant { background: #805ad5; color: white; }
    .badge-ccdf { background: #2c5282; color: white; }
    
    .amount { font-family: 'SF Mono', Monaco, Consolas, monospace; font-weight: 500; }
    
    .search-box { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .search-box input, .search-box select {
      padding: 0.6rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.875rem;
    }
    .search-box input { flex: 1; min-width: 200px; }
    
    .btn {
      padding: 0.6rem 1rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: background 0.2s;
    }
    .btn:hover { background: var(--primary-light); }
    .btn-sm { padding: 0.4rem 0.75rem; font-size: 0.75rem; }
    .btn-outline {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }
    .btn-outline:hover { background: var(--primary); color: white; }
    
    .fraud-summary { display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap; }
    .fraud-count { display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.8rem; }
    
    .data-sources {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
    }
    
    .source-card {
      background: var(--bg);
      padding: 1rem;
      border-radius: 6px;
      border: 1px solid var(--border);
    }
    .source-card h4 { font-size: 0.875rem; margin-bottom: 0.5rem; }
    .source-card a { color: var(--primary); font-size: 0.75rem; word-break: break-all; }
    
    .loading { text-align: center; padding: 2rem; color: var(--text-light); }
    .error { background: #fed7d7; color: #c53030; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; }
    
    .view { display: none; }
    .view.active { display: block; }
    
    .clickable { cursor: pointer; color: var(--primary); }
    .clickable:hover { text-decoration: underline; }
    
    .flag-icon { color: var(--danger); margin-right: 0.25rem; }
    .warning-icon { color: var(--warning); }
    
    .capacity-warning { 
      background: #fed7d7; 
      color: #c53030; 
      padding: 0.15rem 0.4rem; 
      border-radius: 4px; 
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      overflow-y: auto;
      padding: 2rem;
    }
    .modal.active { display: flex; justify-content: center; align-items: flex-start; }
    .modal-content {
      background: white;
      border-radius: 12px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .modal-header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background: white;
      z-index: 1;
    }
    .modal-header h3 { font-size: 1.125rem; }
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-light);
      line-height: 1;
    }
    .modal-close:hover { color: var(--text); }
    .modal-body { padding: 1.5rem; }
    
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .detail-item label {
      display: block;
      font-size: 0.7rem;
      text-transform: uppercase;
      color: var(--text-light);
      margin-bottom: 0.25rem;
    }
    .detail-item .value { font-weight: 500; }
    
    .alert-box {
      background: #fef5e7;
      border: 1px solid #d69e2e;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .alert-box.danger {
      background: #fed7d7;
      border-color: #c53030;
    }
    .alert-box h4 { 
      font-size: 0.875rem; 
      color: var(--warning);
      margin-bottom: 0.5rem;
    }
    .alert-box.danger h4 { color: var(--danger); }
    
    footer {
      text-align: center;
      padding: 2rem;
      color: var(--text-light);
      font-size: 0.875rem;
    }
    footer a { color: var(--primary); }
    
    /* API Key Configuration */
    .api-key-input-group {
      display: flex;
      gap: 0.5rem;
    }
    .api-key-input-group input {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.875rem;
      font-family: 'SF Mono', Monaco, Consolas, monospace;
    }
    
    /* Progress Bar Styles */
    .progress-status {
      font-size: 0.75rem;
      padding: 0.2rem 0.5rem;
      border-radius: 9999px;
    }
    .progress-status.running { background: #bee3f8; color: #2c5282; }
    .progress-status.completed { background: #c6f6d5; color: #276749; }
    .progress-status.failed { background: #fed7d7; color: #c53030; }
    .progress-status.pending { background: #e2e8f0; color: #4a5568; }
    .progress-bar-bg {
      width: 100%;
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--primary-light));
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    
    /* Scraper Grid */
    .scraper-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .scraper-card {
      background: var(--card-bg);
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 1rem;
    }
    .scraper-card h4 {
      font-size: 0.875rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .scraper-card h4 .icon {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
    }
    .scraper-card p {
      font-size: 0.75rem;
      color: var(--text-light);
      margin-bottom: 0.75rem;
    }
    .scraper-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    /* Scraper Progress Bar */
    .scraper-progress {
      display: none;
      margin-top: 0.75rem;
    }
    .scraper-progress.active {
      display: block;
    }
    .progress-bar-container {
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--success), var(--primary));
      background-size: 200% 100%;
      animation: progress-animation 1.5s linear infinite;
      width: 100%;
      border-radius: 4px;
    }
    .progress-bar.complete {
      background: var(--success);
      animation: none;
    }
    .progress-bar.error {
      background: var(--danger);
      animation: none;
    }
    @keyframes progress-animation {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .progress-status {
      font-size: 0.7rem;
      color: var(--text-light);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .progress-status .spinner {
      width: 12px;
      height: 12px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Active Jobs Panel */
    .active-jobs-panel {
      background: var(--primary);
      color: white;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    .active-jobs-panel h3 {
      font-size: 0.875rem;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .active-jobs-panel .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin-top: 1rem;
      padding: 1rem;
    }
    .filter-input {
      width: 100%;
      padding: 0.3rem;
      font-size: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 4px;
      margin-top: 0.25rem;
    }
    #source-top-scrollbar::-webkit-scrollbar { height: 8px; }
    #source-top-scrollbar::-webkit-scrollbar-track { background: var(--bg); }
    #source-top-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
    #source-top-scrollbar::-webkit-scrollbar-thumb:hover { background: #a0aec0; }
    .header-content span { font-weight: 600; margin-bottom: 4px; }
    .active-job-item {
      background: rgba(255,255,255,0.1);
      border-radius: 6px;
      padding: 0.75rem;
    }
    
    @media (max-width: 768px) {
      main { padding: 1rem; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .charts-grid { grid-template-columns: 1fr; }
      .scraper-grid { grid-template-columns: 1fr; }
      table { font-size: 0.75rem; }
      th, td { padding: 0.5rem; }
    }
  </style>
</head>
<body>
  <header>
    <h1>NH Childcare Payments Tracker</h1>
    <div class="header-subtitle">
      <span>CCDF Scholarship Payments to Daycare Providers</span>
      <span class="header-badge">CCDF Fraud Watch</span>
    </div>
  </header>
  
  <nav>
    <a href="#" class="active" data-view="dashboard">Dashboard</a>
    <a href="#" data-view="providers">Providers</a>
    <a href="#" data-view="payments">Payments</a>
    <a href="#" data-view="contracts">DHHS Contracts</a>
    <a href="#" data-view="das-bids">DAS Bids</a>
    <a href="#" data-view="federal">Federal Awards</a>
    <a href="#" data-view="fac-audits">FAC Audits</a>
    <a href="#" data-view="hhs-taggs">HHS TAGGS</a>
    <a href="#" data-view="nonprofits">Nonprofits</a>
    <a href="#" data-view="fraud">Fraud Indicators</a>
    <a href="#" data-view="sources">Data Sources</a>
    <a href="#" data-view="admin">Admin</a>
  </nav>
  
  <main>
    <!-- Dashboard View -->
    <div id="dashboard-view" class="view active">
      <div class="alert-box">
        <h4>Federal CCDF Fraud Context</h4>
        <p style="font-size:0.85rem;">NH receives ~$30M annually in CCDF funds. This tool tracks payments for potential fraud patterns.</p>
      </div>
      
      <div class="card" id="federal-funding-card" style="margin-bottom: 1.5rem; border-left: 4px solid #2c5282;">
        <div class="card-header">
          <h2>Federal CCDF Funding (USAspending.gov)</h2>
          <button class="btn btn-sm btn-outline" onclick="refreshFederalData()" id="refresh-federal-btn">Refresh Data</button>
        </div>
        <div class="card-body" id="federal-funding-content">
          <div class="loading">Loading...</div>
        </div>
      </div>
      
      <div class="stats-grid" id="stats-grid">
        <div class="loading">Loading statistics...</div>
      </div>
      
      <div class="charts-grid">
        <div class="card">
          <div class="card-header"><h2>Payments by City</h2></div>
          <div class="card-body">
            <div class="chart-container"><canvas id="cityChart"></canvas></div>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><h2>Fraud Indicators by Type</h2></div>
          <div class="card-body">
            <div class="chart-container"><canvas id="fraudChart"></canvas></div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h2>Top Providers by CCDF Payments</h2>
          <button class="btn btn-sm btn-outline" onclick="exportData('providers')">Export CSV</button>
        </div>
        <div class="card-body">
          <table id="top-providers">
            <thead>
              <tr><th>Provider</th><th>City</th><th>Type</th><th>Capacity</th><th>Max Children</th><th>Total Payments</th><th>Flags</th></tr>
            </thead>
            <tbody><tr><td colspan="7" class="loading">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Providers View -->
    <div id="providers-view" class="view">
      <div class="search-box">
        <input type="text" id="provider-search" placeholder="Search providers..." onkeyup="if(event.key==='Enter')searchProviders()">
        <select id="provider-filter">
          <option value="">All Providers</option>
          <option value="immigrant">Immigrant-Owned Only</option>
        </select>
        <button class="btn" onclick="searchProviders()">Search</button>
      </div>
      <div class="card">
        <div class="card-header"><h2>Childcare Providers</h2></div>
        <div class="card-body" style="overflow-x:auto;">
          <table id="providers-table">
            <thead>
              <tr><th>Name</th><th>Owner</th><th>City</th><th>Type</th><th>Capacity</th><th>Languages</th><th>Total Payments</th><th>Flags</th></tr>
            </thead>
            <tbody><tr><td colspan="8" class="loading">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Source Data Browser View -->
    <div id="sources-view" class="view">
      
      <!-- Source Metadata Cards -->
      <div class="card">
        <div class="card-header"><h2>Data Sources</h2></div>
        <div class="card-body"><div class="data-sources" id="data-sources-list"></div></div>
      </div>
    
      <!-- Source Data Browser (Combined) -->
      <div class="card">
        <div class="card-header">
           <h2>Raw Source Data</h2>
            <div style="display:flex; gap:0.5rem; align-items: center;">
              <select id="source-table-limit" style="width: auto; font-size: 0.8rem;" onchange="loadSourceTableData(true)">
                <option value="10">10 per page</option>
                <option value="20" selected>20 per page</option>
                <option value="50">50 per page</option>
                <option value="100">100 per page</option>
              </select>
              <select id="source-table-select" onchange="loadSourceTableData(true)">

               <option value="">Loading tables...</option>
             </select>
             <button class="btn btn-sm" onclick="loadSourceTableData()">Load Data</button>
           </div>
        </div>
        <div class="card-body" id="source-table-container">
          <div id="source-table-pagination-top" style="margin-bottom:0.5rem;"></div>
          <div id="source-top-scrollbar" style="overflow-x: auto; overflow-y: hidden; height: 20px; display: none;">
            <div id="source-top-scrollbar-content" style="height: 20px;"></div>
          </div>
          <div id="source-table-scroll-wrapper" style="overflow-x: auto;">
            <p style="color:var(--text-light); text-align:center;">Select a table to view raw data.</p>
          </div>
          <div id="source-table-pagination-bottom" style="margin-top:0.5rem;"></div>
        </div>
      </div>
    </div>

    <!-- Payments View -->
    <div id="payments-view" class="view">
      <div class="search-box">
        <select id="payment-year-filter" onchange="loadPayments()">
          <option value="">All Years</option>
          <option value="2024">FY 2024</option>
          <option value="2023">FY 2023</option>
        </select>
      </div>
      <div class="card">
        <div class="card-header"><h2>CCDF Scholarship Payments</h2></div>
        <div class="card-body" style="overflow-x:auto;">
          <table id="payments-table">
            <thead>
              <tr><th>Provider</th><th>Immigrant?</th><th>FY</th><th>Month</th><th>Amount</th><th>Children</th><th>$/Child</th><th>Funding</th></tr>
            </thead>
            <tbody><tr><td colspan="8" class="loading">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- DHHS Contracts View -->
    <div id="contracts-view" class="view">
      <div class="alert-box" style="border-color: #805ad5; background: #f5f0ff;">
        <h4>üîç DHHS Contract Tracking</h4>
        <p style="font-size:0.85rem;">Tracks DHHS contracts with immigrant/refugee service providers. Cross-references G&C approvals and expenditure data to identify fraud patterns.</p>
      </div>
      
      <!-- Contract Stats -->
      <div class="stats-grid" id="contracts-stats-grid">
        <div class="stat-card"><h3>Total Contracts</h3><div class="value" id="contracts-total">-</div></div>
        <div class="stat-card highlight"><h3>Immigrant-Related</h3><div class="value" id="contracts-immigrant">-</div></div>
        <div class="stat-card danger"><h3>With Fraud Flags</h3><div class="value" id="contracts-fraud">-</div></div>
        <div class="stat-card"><h3>Total Value</h3><div class="value amount" id="contracts-value">-</div></div>
      </div>
      
      <!-- Vendor Summary -->
      <div class="card">
        <div class="card-header">
          <h2>Contracts by Vendor</h2>
          <div style="display:flex;gap:0.5rem;">
            <label><input type="checkbox" id="contracts-immigrant-filter" onchange="loadContracts()"> Immigrant-related only</label>
            <label><input type="checkbox" id="contracts-fraud-filter" onchange="loadContracts()"> With fraud flags only</label>
          </div>
        </div>
        <div class="card-body">
          <div id="contracts-vendor-summary" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;margin-bottom:1.5rem;">
            <div class="loading">Loading vendor summary...</div>
          </div>
        </div>
      </div>
      
      <!-- Contracts Table -->
      <div class="card">
        <div class="card-header">
          <h2>All DHHS Contracts</h2>
          <button class="btn btn-sm" onclick="runDHHSScraper()" id="run-dhhs-scraper-btn">üîÑ Refresh Data</button>
        </div>
        <div class="card-body" style="overflow-x:auto;">
          <table id="contracts-table">
            <thead>
              <tr>
                <th>RFP/RFA #</th>
                <th>Title</th>
                <th>Vendor</th>
                <th>Type</th>
                <th>Value</th>
                <th>Fraud Flags</th>
                <th>Keywords</th>
              </tr>
            </thead>
            <tbody><tr><td colspan="7" class="loading">Loading contracts...</td></tr></tbody>
          </table>
        </div>
      </div>
      
      <!-- Cross-Reference Analysis -->
      <div class="card">
        <div class="card-header">
          <h2>Cross-Reference Analysis</h2>
          <button class="btn btn-sm btn-outline" onclick="runCrossReferenceAnalysis()" id="run-crossref-btn">Run Analysis</button>
        </div>
        <div class="card-body" id="crossref-results">
          <p style="color:var(--text-light);text-align:center;">Click "Run Analysis" to compare contracts, G&C approvals, and expenditure data.</p>
        </div>
      </div>
    </div>
    
    <!-- DAS Bids View -->
    <div id="das-bids-view" class="view">
      <div class="alert-box" style="border-color: #d69e2e; background: #fffbeb;">
        <h4>üèõÔ∏è DAS Bid Board Tracking</h4>
        <p style="font-size:0.85rem;">Tracks NH Department of Administrative Services bid announcements, RFPs, and contract awards. Identifies no-bid contracts, rapid awards, and vendor concentration.</p>
      </div>
      
      <!-- DAS Bids Stats -->
      <div class="stats-grid" id="das-bids-stats-grid">
        <div class="stat-card"><h3>Total Bids</h3><div class="value" id="das-total">-</div></div>
        <div class="stat-card highlight"><h3>Immigrant-Related</h3><div class="value" id="das-immigrant">-</div></div>
        <div class="stat-card danger"><h3>With Fraud Flags</h3><div class="value" id="das-fraud">-</div></div>
        <div class="stat-card"><h3>Total Value</h3><div class="value amount" id="das-value">-</div></div>
      </div>
      
      <!-- DAS Bids Table -->
      <div class="card">
        <div class="card-header">
          <h2>All DAS Bids</h2>
          <div style="display:flex;gap:0.5rem;">
            <label><input type="checkbox" id="das-immigrant-filter" onchange="loadDASBids()"> Immigrant-related only</label>
            <label><input type="checkbox" id="das-fraud-filter" onchange="loadDASBids()"> With fraud flags only</label>
            <button class="btn btn-sm" onclick="runDASScraper()" id="run-das-scraper-btn">üîÑ Refresh</button>
          </div>
        </div>
        <div class="card-body" style="overflow-x:auto;">
          <table id="das-bids-table">
            <thead>
              <tr>
                <th>Bid #</th>
                <th>Title</th>
                <th>Department</th>
                <th>Vendor</th>
                <th>Type</th>
                <th>Status</th>
                <th>Value</th>
                <th>Fraud Flags</th>
              </tr>
            </thead>
            <tbody><tr><td colspan="8" class="loading">Loading bids...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Federal Awards View -->
    <div id="federal-view" class="view">
      <div class="alert-box" style="border-color: #3182ce; background: #ebf8ff;">
        <h4>üá∫üá∏ Federal Awards Tracking (SAM.gov)</h4>
        <p style="font-size:0.85rem;">Tracks federal contracts and grants from SAM.gov awarded to NH refugee/immigrant service providers. Cross-references with state contracts to identify duplicate billing and federal+state overlap.</p>
      </div>
      
      <!-- Federal Stats -->
      <div class="stats-grid" id="federal-stats-grid">
        <div class="stat-card"><h3>Total Awards</h3><div class="value" id="federal-total">-</div></div>
        <div class="stat-card highlight"><h3>Immigrant-Related</h3><div class="value" id="federal-immigrant">-</div></div>
        <div class="stat-card danger"><h3>With Fraud Flags</h3><div class="value" id="federal-fraud">-</div></div>
        <div class="stat-card"><h3>Total Amount</h3><div class="value amount" id="federal-amount">-</div></div>
      </div>
      
      <!-- Federal Awards by Recipient -->
      <div class="card">
        <div class="card-header">
          <h2>Awards by Recipient</h2>
        </div>
        <div class="card-body">
          <div id="federal-recipient-summary" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;margin-bottom:1.5rem;">
            <div class="loading">Loading recipient summary...</div>
          </div>
        </div>
      </div>
      
      <!-- Federal Awards Table -->
      <div class="card">
        <div class="card-header">
          <h2>All Federal Awards</h2>
          <div style="display:flex;gap:0.5rem;">
            <label><input type="checkbox" id="federal-immigrant-filter" onchange="loadFederalAwards()"> Immigrant-related only</label>
            <label><input type="checkbox" id="federal-fraud-filter" onchange="loadFederalAwards()"> With fraud flags only</label>
            <button class="btn btn-sm" onclick="runSAMScraper()" id="run-sam-scraper-btn">üîÑ Refresh</button>
          </div>
        </div>
        <div class="card-body" style="overflow-x:auto;">
          <table id="federal-awards-table">
            <thead>
              <tr>
                <th>Award ID</th>
                <th>Title</th>
                <th>Recipient</th>
                <th>Agency</th>
                <th>Type</th>
                <th>Amount</th>
                <th>Fraud Flags</th>
              </tr>
            </thead>
            <tbody><tr><td colspan="7" class="loading">Loading federal awards...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- FAC Audits View -->
    <div id="fac-audits-view" class="view">
      <div class="alert-box" style="border-color: #38a169; background: #f0fff4;">
        <h4>üîç Federal Audit Clearinghouse (FAC)</h4>
        <p style="font-size:0.85rem;">Tracks Single Audit reports for refugee service providers from the Federal Audit Clearinghouse. Identifies audit findings, questioned costs, material weaknesses, and cross-references with state contract data.</p>
      </div>
      
      <!-- FAC Stats -->
      <div class="stats-grid" id="fac-stats-grid">
        <div class="stat-card"><h3>Total Audits</h3><div class="value" id="fac-total">-</div></div>
        <div class="stat-card highlight"><h3>Refugee-Related</h3><div class="value" id="fac-refugee">-</div></div>
        <div class="stat-card warning"><h3>With Findings</h3><div class="value" id="fac-findings">-</div></div>
        <div class="stat-card danger"><h3>With Fraud Flags</h3><div class="value" id="fac-fraud">-</div></div>
      </div>
      
      <!-- FAC Auditee Summary -->
      <div class="card">
        <div class="card-header">
          <h2>Audits by Organization</h2>
          <div style="display:flex;gap:0.5rem;">
            <label><input type="checkbox" id="fac-refugee-filter" onchange="loadFACAudits()"> Refugee-related only</label>
            <label><input type="checkbox" id="fac-fraud-filter" onchange="loadFACAudits()"> With fraud flags only</label>
            <button class="btn btn-sm" onclick="runFACScraper()" id="run-fac-scraper-btn">üîÑ Refresh</button>
          </div>
        </div>
        <div class="card-body">
          <div id="fac-auditee-summary" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1rem;margin-bottom:1.5rem;">
            <div class="loading">Loading auditee summary...</div>
          </div>
        </div>
      </div>
      
      <!-- FAC Audits Table -->
      <div class="card">
        <div class="card-header">
          <h2>Single Audit Reports</h2>
        </div>
        <div class="card-body" style="overflow-x:auto;">
          <table id="fac-audits-table">
            <thead>
              <tr>
                <th>Auditee</th>
                <th>FY</th>
                <th>Total Expended</th>
                <th>Refugee Programs</th>
                <th>Material Weakness</th>
                <th>Findings</th>
                <th>Fraud Flags</th>
              </tr>
            </thead>
            <tbody><tr><td colspan="7" class="loading">Loading audits...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- HHS TAGGS View -->
    <div id="hhs-taggs-view" class="view">
      <div class="alert-box" style="border-color: #d69e2e; background: #fffaf0;">
        <h4>üí∞ HHS TAGGS (HHS Grant Awards)</h4>
        <p style="font-size:0.85rem;">Tracks HHS grant awards from TAGGS including refugee programs (93.566, 93.567, 93.576) and CCDF childcare programs (93.575, 93.596). Cross-references with state contracts to identify potential double-billing.</p>
      </div>
      
      <!-- TAGGS Stats -->
      <div class="stats-grid" id="taggs-stats-grid">
        <div class="stat-card"><h3>Total Awards</h3><div class="value" id="taggs-total">-</div></div>
        <div class="stat-card highlight"><h3>Refugee Programs</h3><div class="value" id="taggs-refugee">-</div></div>
        <div class="stat-card"><h3>Childcare Programs</h3><div class="value" id="taggs-childcare">-</div></div>
        <div class="stat-card"><h3>Total Amount</h3><div class="value amount" id="taggs-amount">-</div></div>
      </div>
      
      <!-- TAGGS Program Summary -->
      <div class="card">
        <div class="card-header">
          <h2>Awards by Program</h2>
          <div style="display:flex;gap:0.5rem;">
            <label><input type="checkbox" id="taggs-refugee-filter" onchange="loadTAGGSAwards()"> Refugee programs only</label>
            <label><input type="checkbox" id="taggs-childcare-filter" onchange="loadTAGGSAwards()"> Childcare programs only</label>
            <button class="btn btn-sm" onclick="runTAGGSScraper()" id="run-taggs-scraper-btn">üîÑ Refresh</button>
          </div>
        </div>
        <div class="card-body">
          <div id="taggs-program-summary" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;margin-bottom:1.5rem;">
            <div class="loading">Loading program summary...</div>
          </div>
        </div>
      </div>
      
      <!-- TAGGS Awards Table -->
      <div class="card">
        <div class="card-header">
          <h2>All HHS Grant Awards</h2>
        </div>
        <div class="card-body" style="overflow-x:auto;">
          <table id="taggs-awards-table">
            <thead>
              <tr>
                <th>Recipient</th>
                <th>ALN</th>
                <th>Program</th>
                <th>FY</th>
                <th>Amount</th>
                <th>Action</th>
                <th>Fraud Flags</th>
              </tr>
            </thead>
            <tbody><tr><td colspan="7" class="loading">Loading awards...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Nonprofits View -->
    <div id="nonprofits-view" class="view">
      <div class="alert-box" style="border-color: #805ad5; background: #faf5ff;">
        <h4>üè¢ Nonprofit Financial Tracking</h4>
        <p style="font-size:0.85rem;">Tracks NH Charitable Trusts registry and Form 990 data for refugee service providers. Monitors executive compensation, overhead ratios, and revenue/expense discrepancies.</p>
      </div>
      
      <!-- Nonprofit Stats -->
      <div class="stats-grid" id="nonprofit-stats-grid">
        <div class="stat-card"><h3>Total Nonprofits</h3><div class="value" id="nonprofit-total">-</div></div>
        <div class="stat-card highlight"><h3>Refugee Providers</h3><div class="value" id="nonprofit-refugee">-</div></div>
        <div class="stat-card danger"><h3>With Fraud Flags</h3><div class="value" id="nonprofit-fraud">-</div></div>
        <div class="stat-card"><h3>Total Gov Grants</h3><div class="value amount" id="nonprofit-grants">-</div></div>
      </div>
      
      <!-- Nonprofit Cards -->
      <div class="card">
        <div class="card-header">
          <h2>Nonprofit Organizations</h2>
          <div style="display:flex;gap:0.5rem;">
            <label><input type="checkbox" id="nonprofit-refugee-filter" onchange="loadNonprofits()"> Refugee providers only</label>
            <label><input type="checkbox" id="nonprofit-fraud-filter" onchange="loadNonprofits()"> With fraud flags only</label>
            <button class="btn btn-sm" onclick="runTrustsScraper()" id="run-trusts-scraper-btn">üîÑ Refresh</button>
          </div>
        </div>
        <div class="card-body">
          <div id="nonprofit-cards" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:1rem;">
            <div class="loading">Loading nonprofits...</div>
          </div>
        </div>
      </div>
      
      <!-- Nonprofit Details Table -->
      <div class="card">
        <div class="card-header">
          <h2>Financial Details</h2>
        </div>
        <div class="card-body" style="overflow-x:auto;">
          <table id="nonprofit-table">
            <thead>
              <tr>
                <th>Organization</th>
                <th>Total Revenue</th>
                <th>Gov Grants</th>
                <th>Total Expenses</th>
                <th>Program %</th>
                <th>Overhead %</th>
                <th>Top Exec Comp</th>
                <th>Fraud Flags</th>
              </tr>
            </thead>
            <tbody><tr><td colspan="8" class="loading">Loading financials...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Fraud Indicators View -->
    <div id="fraud-view" class="view">
      <div class="card">
        <div class="card-header">
          <h2>Fraud Indicators</h2>
          <div style="display:flex;gap:0.5rem;">
            <select id="fraud-severity-filter" onchange="loadFraudIndicators()"><option value="">All Severities</option><option value="critical">Critical</option><option value="high">High</option><option value="medium">Medium</option><option value="low">Low</option></select>
            <select id="fraud-status-filter" onchange="loadFraudIndicators()"><option value="">All Statuses</option><option value="open">Open</option><option value="investigating">Investigating</option><option value="resolved">Resolved</option><option value="dismissed">Dismissed</option></select>
          </div>
        </div>
        <div class="card-body" style="overflow-x:auto;">
          <table id="fraud-table">
            <thead>
              <tr><th>Severity</th><th>Type</th><th>Description</th><th>Evidence</th><th>Provider</th><th>Status</th></tr>
            </thead>
            <tbody><tr><td colspan="6" class="loading">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Admin Panel View -->
    <div id="admin-view" class="view">
      <div id="admin-login-view">
        <div class="card" style="max-width: 500px; margin: 2rem auto;">
          <div class="card-header"><h2>Admin Authentication</h2></div>
          <div class="card-body">
            <p style="margin-bottom: 1rem; font-size: 0.875rem;">Access to processing features requires an API key.</p>
            <div class="api-key-input-group">
              <input type="password" id="admin-api-key-input" placeholder="Enter ADMIN_API_KEY...">
              <button class="btn" onclick="loginAdmin()">Login</button>
            </div>
            <p id="admin-login-error" style="color: var(--danger); font-size: 0.75rem; margin-top: 0.5rem; display: none;"></p>
          </div>
        </div>
      </div>

      <div id="admin-features-view" style="display: none;">
        <div class="card-header" style="background: white; border-radius: 8px 8px 0 0; margin-bottom: 1.5rem; border: 1px solid var(--border);">
          <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <h2 style="font-size: 1.25rem;">Admin</h2>
            <button class="btn btn-sm btn-outline" onclick="logoutAdmin()">Logout</button>
          </div>
        </div>

        <!-- Instructions Panel -->
        <div class="card" style="border-left: 4px solid #3182ce; margin-bottom: 1.5rem;">
          <div class="card-header"><h2>üìã Data Ingestion Workflow</h2></div>
          <div class="card-body" style="font-size: 0.875rem;">
            <p style="margin-bottom: 1rem;"><strong>Initial Setup (one-time):</strong></p>
            <ol style="margin-left: 1.5rem; margin-bottom: 1rem;">
              <li><strong>NH CCIS</strong> - Run first to populate the master provider directory</li>
              <li><strong>TransparentNH Historical</strong> - Load all fiscal years (FY 2009-2026) ~30 min</li>
              <li><strong>USAspending</strong> - Fetch federal CCDF awards</li>
              <li><strong>Pattern Analysis</strong> - Run fraud detection</li>
            </ol>
            <p style="margin-bottom: 0.5rem;"><strong>Recurring Updates (automatic):</strong></p>
            <ul style="margin-left: 1.5rem; font-size: 0.8rem; color: var(--text-light);">
              <li>CCIS Provider Directory - Weekly (Friday 4 AM UTC)</li>
              <li>TransparentNH Current FY - Weekly (Saturday 3 AM UTC)</li>
              <li>USAspending - Daily (6 AM UTC)</li>
              <li>Fraud Analysis - Weekly (Monday 8 AM UTC)</li>
            </ul>
          </div>
        </div>

        <div id="active-jobs-panel" class="active-jobs-panel" style="display:none;">
          <h3><span class="spinner"></span> Active Scraper Jobs</h3>
          <div id="active-jobs-list" class="active-jobs-list"></div>
        </div>
        
        <div class="card">
          <div class="card-header"><h2>Data Scrapers & Ingestion</h2><button class="btn btn-sm btn-outline" onclick="refreshJobStatus()">Refresh Status</button></div>
          <div class="card-body">
            <div class="scraper-grid">
              <!-- CCIS Provider Directory -->
              <div class="scraper-card" id="card-ccis" style="border-left: 3px solid #805ad5;">
                <h4><span class="icon" style="background:#805ad5;color:white;">üë∂</span>NH CCIS Provider Directory</h4>
                <p>Authoritative source of NH childcare providers. Run FIRST to populate provider_master table.</p>
                <div class="scraper-actions">
                  <button class="btn btn-sm" onclick="startCCISScraper()">Scrape CCIS</button>
                </div>
                <div class="scraper-progress" id="progress-ccis">
                  <div class="progress-bar-container"><div class="progress-bar"></div></div>
                  <div class="progress-status"><span class="spinner"></span><span class="status-text">Initializing...</span></div>
                </div>
              </div>

              <!-- TransparentNH Historical -->
              <div class="scraper-card" id="card-tnh-historical" style="border-left: 3px solid #d69e2e;">
                <h4><span class="icon" style="background:#d69e2e;color:white;">üìö</span>TransparentNH Historical</h4>
                <p>One-time ingestion of ALL fiscal years (FY 2009-2026). Takes ~30 minutes.</p>
                <div class="scraper-actions">
                  <button class="btn btn-sm" onclick="startTransparentNHHistorical()">Load All Years</button>
                </div>
                <div class="scraper-progress" id="progress-tnh-historical">
                  <div class="progress-bar-container"><div class="progress-bar"></div></div>
                  <div class="progress-status"><span class="spinner"></span><span class="status-text">Initializing...</span></div>
                </div>
              </div>

              <!-- TransparentNH Current Year -->
              <div class="scraper-card" id="card-tnh-current" style="border-left: 3px solid #38a169;">
                <h4><span class="icon" style="background:#38a169;color:white;">$</span>TransparentNH Current FY</h4>
                <p>Ingest current fiscal year expenditures. Updated throughout the year.</p>
                <div class="scraper-actions">
                  <button class="btn btn-sm" onclick="startTransparentNHCurrentYear()">Scrape FY 2026</button>
                </div>
                <div class="scraper-progress" id="progress-tnh-current">
                  <div class="progress-bar-container"><div class="progress-bar"></div></div>
                  <div class="progress-status"><span class="spinner"></span><span class="status-text">Initializing...</span></div>
                </div>
              </div>

              <!-- USAspending -->
              <div class="scraper-card" id="card-usaspending">
                <h4><span class="icon" style="background:#3182ce;color:white;">F</span>USAspending.gov (Federal)</h4>
                <p>Fetch federal CCDF grant awards to NH.</p>
                <div class="scraper-actions"><button class="btn btn-sm" onclick="startUSASpendingScraper()">Fetch Awards</button></div>
                <div class="scraper-progress" id="progress-usaspending">
                  <div class="progress-bar-container"><div class="progress-bar"></div></div>
                  <div class="progress-status"><span class="spinner"></span><span class="status-text">Initializing...</span></div>
                </div>
              </div>

              <!-- Pattern Analysis -->
              <div class="scraper-card" id="card-fraud">
                <h4><span class="icon" style="background:#e53e3e;color:white;">!</span>Pattern Analysis</h4>
                <p>Run fraud detection algorithms on all expenditure data.</p>
                <div class="scraper-actions"><button class="btn btn-sm" onclick="startFraudAnalysis()">Run Full Analysis</button></div>
                <div class="scraper-progress" id="progress-fraud">
                  <div class="progress-bar-container"><div class="progress-bar"></div></div>
                  <div class="progress-status"><span class="spinner"></span><span class="status-text">Initializing...</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="border-top: 4px solid var(--danger);">
          <div class="card-header"><h2>System Administration</h2></div>
          <div class="card-body">
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
              <div style="flex: 1; min-width: 250px; background: var(--bg); padding: 1rem; border-radius: 6px;">
                <h4 style="font-size: 0.875rem; margin-bottom: 0.5rem;">Database Maintenance</h4>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                  <button class="btn btn-sm btn-outline" onclick="confirmInitDb()" style="color: var(--danger); border-color: var(--danger);">Initialize / Reset Schema</button>
                </div>
              </div>
              <div style="flex: 1; min-width: 250px; background: var(--bg); padding: 1rem; border-radius: 6px;">
                <h4 style="font-size: 0.875rem; margin-bottom: 0.5rem;">System Information</h4>
                <button class="btn btn-sm btn-outline" onclick="viewDbInfo()">Check Connection</button>
                <div id="db-info-result" style="font-size: 0.7rem; margin-top: 0.5rem; max-height: 100px; overflow-y: auto;"></div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header"><h2>Ingestion & Job History</h2><button class="btn btn-sm btn-outline" onclick="loadIngestionHistory()">Refresh</button></div>
          <div class="card-body" style="overflow-x:auto;">
            <table id="ingestion-history-table">
              <thead><tr><th>Source</th><th>Status</th><th>Processed</th><th>Imported</th><th>Started</th><th>Details</th></tr></thead>
              <tbody id="ingestion-history-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Data Sources View -->
    <div id="sources-view" class="view">
      <div class="card">
        <div class="card-header"><h2>Data Sources</h2></div>
        <div class="card-body"><div class="data-sources" id="data-sources-list"></div></div>
      </div>
    </div>
  </main>
  
  <div id="provider-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h3 id="provider-modal-title">Provider Details</h3><button class="modal-close" onclick="closeModal('provider-modal')">&times;</button></div>
      <div class="modal-body" id="provider-modal-body"></div>
    </div>
  </div>
  
  <script>
    const API_BASE = '/api';
    let cityChart, fraudChart;
    let activeTriggerPollers = {};
    
    window.onload = () => { 
      loadDashboard(); 
      // Initial view based on hash or default to dashboard
      const initialView = window.location.hash.slice(1) || 'dashboard';
      showView(initialView);
      checkAdminStatus(); 
    };

    window.onhashchange = () => {
      const viewName = window.location.hash.slice(1) || 'dashboard';
      showView(viewName);
    };
    
    function getApiKey() { return localStorage.getItem('nh-tracker-api-key') || ''; }
    function loginAdmin() {
      const key = document.getElementById('admin-api-key-input').value;
      if (!key) { alert('Enter key'); return; }
      localStorage.setItem('nh-tracker-api-key', key);
      checkAdminStatus();
    }
    function logoutAdmin() { localStorage.removeItem('nh-tracker-api-key'); checkAdminStatus(); }
    function checkAdminStatus() {
      const key = getApiKey();
      const loginView = document.getElementById('admin-login-view');
      const featuresView = document.getElementById('admin-features-view');
      if (loginView) loginView.style.display = key ? 'none' : 'block';
      if (featuresView) featuresView.style.display = key ? 'block' : 'none';
      if (key) { loadIngestionHistory(); refreshJobStatus(); }
    }
    function getAuthHeaders() { return { 'Content-Type': 'application/json', 'x-api-key': getApiKey() }; }

    // Progress bar helpers
    function showProgress(cardId, statusText = 'Initializing...') {
      const progress = document.getElementById(`progress-${cardId}`);
      if (progress) {
        progress.classList.add('active');
        const bar = progress.querySelector('.progress-bar');
        bar.classList.remove('complete', 'error');
        updateProgressStatus(cardId, statusText);
      }
    }

    function updateProgressStatus(cardId, statusText) {
      const progress = document.getElementById(`progress-${cardId}`);
      if (progress) {
        const text = progress.querySelector('.status-text');
        if (text) text.textContent = statusText;
      }
    }

    function completeProgress(cardId, statusText = 'Complete!', isError = false) {
      const progress = document.getElementById(`progress-${cardId}`);
      if (progress) {
        const bar = progress.querySelector('.progress-bar');
        const spinner = progress.querySelector('.spinner');
        bar.classList.add(isError ? 'error' : 'complete');
        if (spinner) spinner.style.display = 'none';
        updateProgressStatus(cardId, statusText);
        // Hide after 5 seconds
        setTimeout(() => {
          progress.classList.remove('active');
          if (spinner) spinner.style.display = '';
        }, 5000);
      }
    }

    function hideProgress(cardId) {
      const progress = document.getElementById(`progress-${cardId}`);
      if (progress) progress.classList.remove('active');
    }

    document.querySelectorAll('nav a').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const viewName = e.target.dataset.view;
        window.location.hash = viewName;
      });
    });
    
    function showView(viewName) {
      const validViews = ['dashboard', 'providers', 'payments', 'contracts', 'das-bids', 'federal', 'fac-audits', 'hhs-taggs', 'nonprofits', 'fraud', 'sources', 'admin'];
      if (!validViews.includes(viewName)) return;

      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById(`${viewName}-view`).classList.add('active');
      
      document.querySelectorAll('nav a').forEach(a => {
        a.classList.toggle('active', a.getAttribute('data-view') === viewName);
      });

      switch(viewName) {
        case 'dashboard': loadDashboard(); break;
        case 'providers': loadProviders(); break;
        case 'payments': loadPayments(); break;
        case 'contracts': loadContracts(); break;
        case 'das-bids': loadDASBids(); break;
        case 'federal': loadFederalAwards(); break;
        case 'fac-audits': loadFACAudits(); break;
        case 'hhs-taggs': loadTAGGSAwards(); break;
        case 'nonprofits': loadNonprofits(); break;
        case 'fraud': loadFraud(); break;
        case 'sources': loadDataSources(); loadSourceTables(); break;
      }
      
      if (viewName === 'admin') checkAdminStatus();
      
      // Trigger data loading for specific views if not already loaded
      switch(viewName) {
        case 'providers': loadProviders(); break;
        case 'payments': loadPayments(); break;
        case 'contracts': loadContracts(); break;
        case 'das-bids': loadDASBids(); break;
        case 'federal': loadFederalAwards(); break;
        case 'fac-audits': loadFACAudits(); break;
        case 'hhs-taggs': loadTAGGSAwards(); break;
        case 'nonprofits': loadNonprofits(); break;
        case 'fraud': loadFraudIndicators(); break;
        case 'sources': loadDataSources(); loadSourceTables(); break;
      }
    }
    
    let sourceTableState = {
      page: 1,
      limit: 20,
      filters: {}
    };

    async function loadSourceTables() {
      const key = getApiKey();
      if (!key) {
        const select = document.getElementById('source-table-select');
        if (select) select.innerHTML = '<option value="">Admin Login Required</option>';
        return;
      }
      try {
        const res = await fetch(`${API_BASE}/admin/sources`, { headers: getAuthHeaders() });
        if (!res.ok) {
          const err = await res.json().catch(() => ({ error: res.statusText }));
          throw new Error(err.error || `HTTP ${res.status}`);
        }
        const data = await res.json();
        const select = document.getElementById('source-table-select');
        if (!data.tables || data.tables.length === 0) {
          select.innerHTML = '<option value="">No source tables found</option>';
          return;
        }
        select.innerHTML = '<option value="">Select a source table...</option>' +
          data.tables.map(t => `<option value="${t}">${t}</option>`).join('');
      } catch (e) {
          console.error(e);
          document.getElementById('source-table-select').innerHTML = '<option value="">Error: ' + (e.message || 'Failed to load') + '</option>';
      }
    }

    function updateSourceFilter(column, value) {
      sourceTableState.filters[column] = value;
      sourceTableState.page = 1; // Reset to page 1 on filter change
      loadSourceTableData();
    }

    function changeSourcePage(delta) {
      sourceTableState.page += delta;
      loadSourceTableData();
    }

    function renderPagination(p) {
      return `
        <div class="pagination">
          <button class="btn btn-sm btn-outline" ${p.currentPage <= 1 ? 'disabled' : ''} onclick="changeSourcePage(-1)">Previous</button>
          <span style="font-size:0.875rem;">Page <strong>${p.currentPage}</strong> of <strong>${p.totalPages}</strong> (${p.totalCount} total records)</span>
          <button class="btn btn-sm btn-outline" ${p.currentPage >= p.totalPages ? 'disabled' : ''} onclick="changeSourcePage(1)">Next</button>
        </div>
      `;
    }

    async function loadSourceTableData(reset = false) {
      const table = document.getElementById('source-table-select').value;
      if (!table) return;
      
      const limitSelect = document.getElementById('source-table-limit');
      sourceTableState.limit = parseInt(limitSelect.value, 10);

      if (reset) {
        sourceTableState.page = 1;
        sourceTableState.filters = {};
      }

      const container = document.getElementById('source-table-container');
      const paginationTop = document.getElementById('source-table-pagination-top');
      const paginationBottom = document.getElementById('source-table-pagination-bottom');
      const wrapper = document.getElementById('source-table-scroll-wrapper');
      const topScroll = document.getElementById('source-top-scrollbar');
      const topScrollContent = document.getElementById('source-top-scrollbar-content');

      // Loading state
      wrapper.innerHTML = '<p style="text-align:center;padding:2rem;"><span class="spinner"></span> Loading data...</p>';
      paginationTop.innerHTML = '';
      paginationBottom.innerHTML = '';
      topScroll.style.display = 'none';
      
      try {
        const queryParams = new URLSearchParams({
          page: sourceTableState.page,
          limit: sourceTableState.limit
        });
        
        Object.keys(sourceTableState.filters).forEach(col => {
          if (sourceTableState.filters[col]) {
            queryParams.append(`filter_${col}`, sourceTableState.filters[col]);
          }
        });

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout

        let res;
        try {
          res = await fetch(`${API_BASE}/admin/sources/${table}?${queryParams.toString()}`, {
            headers: getAuthHeaders(),
            signal: controller.signal
          });
        } finally {
          clearTimeout(timeoutId);
        }

        if (!res.ok) {
          const err = await res.json().catch(() => ({ error: res.statusText }));
          throw new Error(err.error || `HTTP ${res.status}`);
        }
        const data = await res.json();

        if (!data.rows) {
          throw new Error(data.error || 'No data returned from server');
        }

        if (data.rows.length === 0 && sourceTableState.page === 1 && Object.keys(sourceTableState.filters).length === 0) {
          wrapper.innerHTML = '<p style="text-align:center;padding:2rem;">No records found in this table.</p>';
          return;
        }
        
        const cols = data.rows.length > 0 ? Object.keys(data.rows[0]) : Object.keys(sourceTableState.filters);
        const p = data.pagination;
        const paginationHtml = renderPagination(p);
        
        paginationTop.innerHTML = paginationHtml;
        paginationBottom.innerHTML = paginationHtml;

        let tableHtml = '<table><thead><tr>';
        cols.forEach(c => {
          tableHtml += `
            <th>
              <div class="header-content">
                <span>${c}</span>
                <input type="text" class="filter-input" placeholder="Filter..." 
                  value="${sourceTableState.filters[c] || ''}" 
                  onkeyup="if(event.key==='Enter') updateSourceFilter('${c}', this.value)"
                  onblur="updateSourceFilter('${c}', this.value)">
              </div>
            </th>`;
        });
        tableHtml += '</tr></thead><tbody>';
        
        if (data.rows.length === 0) {
          tableHtml += `<tr><td colspan="${cols.length}" style="text-align:center;padding:2rem;color:var(--text-light);">No results matching your filters.</td></tr>`;
        } else {
          tableHtml += data.rows.map(row => `<tr>${cols.map(c => `<td>${row[c] || ''}</td>`).join('')}</tr>`).join('');
        }
        tableHtml += '</tbody></table>';
        wrapper.innerHTML = tableHtml;

        // Sync Top Scrollbar
        setTimeout(() => {
          const tableEl = wrapper.querySelector('table');
          if (tableEl && tableEl.offsetWidth > wrapper.offsetWidth) {
            topScroll.style.display = 'block';
            topScrollContent.style.width = tableEl.offsetWidth + 'px';
            
            // Link scroll positions
            topScroll.onscroll = () => { wrapper.scrollLeft = topScroll.scrollLeft; };
            wrapper.onscroll = () => { topScroll.scrollLeft = wrapper.scrollLeft; };
          } else {
            topScroll.style.display = 'none';
          }
        }, 100);

      } catch (e) {
        const msg = e.name === 'AbortError' ? 'Request timed out. The server may be slow or unavailable.' : e.message;
        wrapper.innerHTML = `<p style="color:var(--danger);padding:2rem;">Error: ${msg}</p>`;
      }
    }

    async function loadDataSources() {
      const container = document.getElementById('data-sources-list');
      container.innerHTML = '<div class="loading">Loading data sources...</div>';
      try {
        const res = await fetch(`${API_BASE}/data-sources`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (!data.sources || data.sources.length === 0) {
          container.innerHTML = '<p style="color:var(--text-light);">No data sources configured.</p>';
          return;
        }
        container.innerHTML = data.sources.map(s => `
          <div class="source-card">
            <h4>${s.name}</h4>
            <p style="font-size:0.8rem; margin-bottom:0.5rem;">${s.description}</p>
            <div style="font-size:0.75rem; color:var(--text-light);">
              <div style="margin-bottom:0.25rem;"><strong>URL:</strong> <a href="${s.url}" target="_blank">${s.url}</a></div>
              <div><strong>Update Frequency:</strong> ${s.frequency}</div>
              <div><strong>Last Updated:</strong> ${s.last_updated ? new Date(s.last_updated).toLocaleDateString() : 'Never'}</div>
            </div>
          </div>
        `).join('');
      } catch (e) {
        container.innerHTML = `<div class="error">Failed to load data sources: ${e.message}</div>`;
      }
    }

    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    
    function formatCurrency(v) { return '$' + Number(v||0).toLocaleString(); }
    function formatMonth(y, m) { return m ? ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][m-1] + ' ' + y : '-'; }
    function severityBadge(s) { return `<span class="badge badge-${s||'low'}">${(s||'low').toUpperCase()}</span>`; }
    function statusBadge(s) { return `<span class="badge badge-${s||'open'}">${s||'open'}</span>`; }
    function capacityStatus(ch, c) { return ch > c ? `<span class="capacity-warning">OVER</span>` : `<span style="color:var(--success)">${ch||0}/${c||0}</span>`; }

    async function loadDashboard() {
      try {
        const [dashRes, federalRes] = await Promise.all([fetch(`${API_BASE}/dashboard`), fetch(`${API_BASE}/federal/summary`)]);
        const data = await dashRes.json();
        const fed = await federalRes.json();
        renderFederalFunding(fed);
        document.getElementById('stats-grid').innerHTML = `<div class="stat-card"><h3>Total Providers</h3><div class="value">${data.total_providers}</div></div><div class="stat-card"><h3>CCDF Payments</h3><div class="value">${formatCurrency(data.total_payments)}</div></div><div class="stat-card"><h3>Fraud Flags</h3><div class="value">${data.fraud_indicators_count}</div></div>`;
        document.querySelector('#top-providers tbody').innerHTML = data.top_providers.map(p => `<tr><td class="clickable" onclick="showProviderDetail(${p.id})">${p.canonical_name}</td><td>${p.city}</td><td>${p.provider_type}</td><td>${p.capacity}</td><td class="amount">${formatCurrency(p.total_payments)}</td><td>${p.fraud_count}</td></tr>`).join('');
      } catch (e) { console.error(e); }
    }

    function renderFederalFunding(fed) {
      document.getElementById('federal-funding-content').innerHTML = `<div>Total: ${formatCurrency(fed.totalFederalAmount)} | Awards: ${fed.totalAwards}</div>`;
    }

    async function refreshFederalData() {
      await fetch(`${API_BASE}/federal/awards?refresh=true`, { headers: getAuthHeaders() });
      loadDashboard();
    }

    async function loadProviders() {
      const res = await fetch(`${API_BASE}/providers`);
      const data = await res.json();
      document.querySelector('#providers-table tbody').innerHTML = data.map(p => `<tr><td class="clickable" onclick="showProviderDetail(${p.id})">${p.canonical_name}</td><td>${p.city}</td><td>${p.provider_type}</td><td>${p.capacity}</td><td>${formatCurrency(p.total_payments || 0)}</td><td>${p.fraud_count || 0}</td></tr>`).join('');
    }

    async function showProviderDetail(id) {
      const res = await fetch(`${API_BASE}/providers/${id}`);
      const p = await res.json();
      const content = `
        <div class="provider-detail">
          <h2>${p.canonical_name}</h2>
          <div class="grid">
            <div>
              <p><strong>City:</strong> ${p.city}</p>
              <p><strong>Type:</strong> ${p.provider_type}</p>
              <p><strong>Capacity:</strong> ${p.capacity}</p>
            </div>
            <div>
              <p><strong>CCDF ID:</strong> ${p.ccis_provider_id}</p>
              <p><strong>Quality:</strong> ${p.quality_rating || 'N/A'}</p>
              <p><strong>Active:</strong> ${p.is_active ? 'Yes' : 'No'}</p>
            </div>
          </div>
          <h3>Payments</h3>
          <table><thead><tr><th>Date</th><th>Amount</th><th>Source</th></tr></thead><tbody>${p.payments.map(pay => `<tr><td>${pay.payment_date}</td><td>${formatCurrency(pay.amount)}</td><td>${pay.funding_source}</td></tr>`).join('')}</tbody></table>
        </div>
      `;
      // showModal(content);
      openModal('provider-modal');
      document.getElementById('provider-modal-title').textContent = p.name_display || p.canonical_name;
      document.getElementById('provider-modal-body').innerHTML = content;
    }

    /*
    async function showProviderDetail(id) {
      openModal('provider-modal');
      const res = await fetch(`${API_BASE}/providers/${id}`);
      const p = await res.json();
      document.getElementById('provider-modal-title').textContent = p.name;
      document.getElementById('provider-modal-body').innerHTML = `<div class="detail-grid"><div><label>City</label>${p.city}</div><div><label>Payments</label>${formatCurrency(p.total_payments)}</div></div>`;
    }
    */

    async function loadIngestionHistory() {
      const res = await fetch(`${API_BASE}/ingestion/runs`, { headers: getAuthHeaders() });
      const data = await res.json();
      document.getElementById('ingestion-history-body').innerHTML = (data.runs || []).map(r => `<tr><td>${r.source}</td><td>${r.status}</td><td>${r.records_processed}</td><td>${r.records_imported}</td><td>${new Date(r.started_at).toLocaleString()}</td><td><button onclick='alert(JSON.stringify(${JSON.stringify(r.details)}))'>View</button></td></tr>`).join('');
    }

    let currentRunId = null;

    async function refreshJobStatus() {
      try {
        const res = await fetch(`${API_BASE}/trigger/runs`, { headers: getAuthHeaders() });
        if (!res.ok) return;
        const data = await res.json();
        const runs = data.runs || [];

        // Check specific run status if we are tracking one
        if (currentRunId) {
          // Fetch detailed run info with metadata
          try {
            const runRes = await fetch(`${API_BASE}/trigger/runs/${currentRunId}`, { headers: getAuthHeaders() });
            if (runRes.ok) {
              const run = await runRes.json();
              const meta = run.metadata || {};
              const progress = meta.progress || 0;
              const status = meta.status || run.status;

              // Update progress bar width
              const progressBar = document.querySelector('#progress-ccis .progress-bar');
              if (progressBar) {
                progressBar.style.width = `${progress}%`;
              }

              // Update status text
              if (meta.status) {
                updateProgressStatus('ccis', meta.status);
              }

              const runStatus = (run.status || '').toUpperCase();
              if (runStatus === 'COMPLETED') {
                const finalStatus = meta.status || `Done! ${run.output?.totalFound || ''} providers updated`;
                completeProgress('ccis', finalStatus);
                currentRunId = null;
              } else if (runStatus === 'FAILED' || runStatus === 'CANCELED') {
                completeProgress('ccis', meta.status || `Job ${run.status}`, true);
                currentRunId = null;
              }
            }
          } catch (e) {
            // Fall back to list-based tracking
            const run = runs.find(r => r.id === currentRunId);
            if (run) {
              const runStatus = (run.status || '').toUpperCase();
              if (runStatus === 'COMPLETED') {
                completeProgress('ccis', 'Job Completed Successfully!');
                currentRunId = null;
              } else if (runStatus === 'FAILED' || runStatus === 'CANCELED') {
                completeProgress('ccis', `Job ${run.status}`, true);
                currentRunId = null;
              }
            }
          }
        }

        const active = runs.filter(r => ['EXECUTING','PENDING', 'QUEUED', 'REATTEMPTING'].includes((r.status || '').toUpperCase()));

        currentActiveJob = active.length > 0 ? active[0] : null;

        // Update active jobs panel
        const panel = document.getElementById('active-jobs-panel');
        if (panel) {
          panel.style.display = currentActiveJob ? 'block' : 'none';
          document.getElementById('active-jobs-list').innerHTML = active.map(r => {
            const meta = r.metadata || {};
            const progress = meta.progress || (r.status === 'EXECUTING' ? 50 : 10);
            const statusText = meta.status || r.status;
            return `
            <div class="active-job-item">
              <div style="display:flex; justify-content:space-between; margin-bottom:0.5rem;">
                <strong>${r.taskIdentifier}</strong>
                <span class="badge">${r.status}</span>
              </div>
              <div class="progress-bar-bg">
                <div class="progress-bar-fill" style="width: ${progress}%"></div>
              </div>
              <div style="font-size:0.75rem; color:rgba(255,255,255,0.9); margin-top:0.25rem;">${statusText}</div>
              <div style="font-size:0.7rem; color:rgba(255,255,255,0.6)">Started: ${new Date(r.createdAt).toLocaleString()}</div>
            </div>
          `}).join('');
        }

        // Disable/Enable trigger buttons
        const triggerButtons = document.querySelectorAll('.scraper-card button, .card-header button[onclick^="start"]');
        const isAnyActive = active.length > 0;

        triggerButtons.forEach(btn => {
          btn.disabled = isAnyActive;
          if (isAnyActive) {
            btn.style.opacity = '0.5';
            btn.style.cursor = 'not-allowed';
          } else {
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
          }
        });

        // Polling if active or if we are tracking a specific run that might have finished but we haven't seen it yet
        if (isAnyActive || currentRunId) {
          setTimeout(refreshJobStatus, 2000); // Poll every 2 seconds for better responsiveness
        }
      } catch (e) { console.error('Job status refresh failed:', e); }
    }

    async function safeTrigger(taskFn, ...args) {
      if (currentActiveJob) {
        alert('A background task is already running. Please wait for it to complete.');
        return;
      }
      
      // Immediately disable buttons to prevent double-click
      const triggerButtons = document.querySelectorAll('.scraper-card button, .card-header button[onclick^="start"]');
      triggerButtons.forEach(btn => {
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
      });

      try {
        await taskFn(...args);
      } catch (e) {
        alert('Task failed to start: ' + e.message);
        refreshJobStatus();
      }
    }

    // ... (rest of functions)

    async function startCCISScraper() {
      showProgress('ccis', 'Connecting to CCIS portal...');
      await safeTrigger(async () => {
        updateProgressStatus('ccis', 'Scraping provider directory...');
        const res = await fetch(`${API_BASE}/trigger/ccis`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({})
        });
        if (!res.ok) {
          const err = await res.json();
          completeProgress('ccis', err.error || 'Failed', true);
          throw new Error(err.error || 'Failed to start CCIS scraper');
        }
        const data = await res.json();
        
        // When running in Trigger.dev, the initial response just gives us the Run ID
        if (data.runId) {
          currentRunId = data.runId; // Track this run
          updateProgressStatus('ccis', `Job Queued (Run ID: ${data.runId.slice(0,8)}...)`);
        } else {
          // Fallback for local execution/direct results
          const count = data.result?.providersImported || 'unknown';
          completeProgress('ccis', `Done! ${count} providers imported`);
        }
        
        refreshJobStatus();
      });
    }

    async function startTransparentNHHistorical() {
      if (!confirm('This will download ALL fiscal years (FY 2009-2026). This takes ~30 minutes. Continue?')) return;
      showProgress('tnh-historical', 'Starting historical ingestion...');
      await safeTrigger(async () => {
        updateProgressStatus('tnh-historical', 'Downloading 18 fiscal years...');
        const res = await fetch(`${API_BASE}/trigger/transparent-nh-historical`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({})
        });
        if (!res.ok) {
          const err = await res.json();
          completeProgress('tnh-historical', err.error || 'Failed', true);
          throw new Error(err.error || 'Failed to start historical ingestion');
        }
        const data = await res.json();
        const years = data.result?.length || 0;
        completeProgress('tnh-historical', `Done! ${years} fiscal years processed`);
        refreshJobStatus();
      });
    }

    async function startTransparentNHCurrentYear() {
      showProgress('tnh-current', 'Downloading FY 2026 data...');
      await safeTrigger(async () => {
        updateProgressStatus('tnh-current', 'Processing expenditure records...');
        const res = await fetch(`${API_BASE}/trigger/transparent-nh-current`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({})
        });
        if (!res.ok) {
          const err = await res.json();
          completeProgress('tnh-current', err.error || 'Failed', true);
          throw new Error(err.error || 'Failed to start current year ingestion');
        }
        const data = await res.json();
        const records = data.result?.childcareRecords || 0;
        completeProgress('tnh-current', `Done! ${records.toLocaleString()} records`);
        refreshJobStatus();
      });
    }

    async function startUSASpendingScraper() {
      showProgress('usaspending', 'Fetching federal awards...');
      await safeTrigger(async () => {
        updateProgressStatus('usaspending', 'Querying USAspending API...');
        const res = await fetch(`${API_BASE}/trigger/usaspending`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({})
        });
        if (!res.ok) {
          const err = await res.json();
          completeProgress('usaspending', err.error || 'Failed', true);
          throw new Error(err.error || 'Failed to start USAspending scraper');
        }
        const data = await res.json();
        // Trigger.dev v3 returns runId
        if (data.runId) {
            updateProgressStatus('usaspending', `Job Queued (Run ID: ${data.runId.slice(0,8)}...)`);
        } else {
            completeProgress('usaspending', 'Done! Awards updated.');
        }
        refreshJobStatus();
      });
    }

    async function startFraudAnalysis() {
      showProgress('fraud', 'Starting pattern analysis...');
      await safeTrigger(async () => {
        updateProgressStatus('fraud', 'Running fraud detection algorithms...');
        const res = await fetch(`${API_BASE}/trigger/fraud-analysis`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({})
        });
        if (!res.ok) {
          const err = await res.json();
          completeProgress('fraud', err.error || 'Failed', true);
          throw new Error(err.error || 'Failed to start fraud analysis');
        }
        const data = await res.json();
        // Trigger.dev v3 returns runId
        if (data.runId) {
            updateProgressStatus('fraud', `Job Queued (Run ID: ${data.runId.slice(0,8)}...)`);
        } else {
            const count = data.result?.flagsGenerated || 0;
            completeProgress('fraud', `Done! ${count} flags generated`);
        }
        refreshJobStatus();
      });
    }

    // ==========================================
    // DHHS Contracts Functions
    // ==========================================
    
    async function loadContracts() {
      const immigrantOnly = document.getElementById('contracts-immigrant-filter')?.checked || false;
      const fraudOnly = document.getElementById('contracts-fraud-filter')?.checked || false;
      
      try {
        const params = new URLSearchParams();
        if (immigrantOnly) params.append('immigrant_related', 'true');
        if (fraudOnly) params.append('with_fraud_indicators', 'true');
        
        const res = await fetch(`${API_BASE}/dhhs-contracts?${params}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        
        // Update stats
        document.getElementById('contracts-total').textContent = data.stats.total;
        document.getElementById('contracts-immigrant').textContent = data.stats.immigrantRelated;
        document.getElementById('contracts-fraud').textContent = data.stats.withFraudIndicators;
        document.getElementById('contracts-value').textContent = formatCurrency(data.stats.totalValue);
        
        // Render vendor summary cards
        const vendorSummary = document.getElementById('contracts-vendor-summary');
        const vendors = Object.entries(data.stats.byVendor).sort((a, b) => b[1].totalValue - a[1].totalValue);
        
        if (vendors.length === 0) {
          vendorSummary.innerHTML = '<p style="color:var(--text-light);">No contracts found.</p>';
        } else {
          vendorSummary.innerHTML = vendors.map(([vendor, info]) => `
            <div class="source-card" style="border-left: 3px solid ${info.count >= 3 ? 'var(--danger)' : 'var(--primary)'};">
              <h4>${vendor}</h4>
              <div style="font-size:0.85rem;">
                <div><strong>Contracts:</strong> ${info.count} ${info.count >= 3 ? '<span class="badge badge-high">CONCENTRATED</span>' : ''}</div>
                <div><strong>Total Value:</strong> <span class="amount">${formatCurrency(info.totalValue)}</span></div>
              </div>
            </div>
          `).join('');
        }
        
        // Render contracts table
        const tbody = document.querySelector('#contracts-table tbody');
        if (data.contracts.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-light);">No contracts found.</td></tr>';
        } else {
          tbody.innerHTML = data.contracts.map(c => {
            const fraudBadges = (c.fraudIndicators || []).map(f => 
              `<span class="badge badge-${f.severity}" title="${f.description}">${f.type}</span>`
            ).join(' ');
            const keywords = (c.matchedKeywords || []).slice(0, 3).map(k => 
              `<span class="badge badge-immigrant" style="font-size:0.6rem;">${k}</span>`
            ).join(' ');
            
            return `
              <tr onclick="showContractDetail('${c.rfpNumber}')" style="cursor:pointer;">
                <td class="clickable">${c.rfpNumber}</td>
                <td>${c.title}</td>
                <td>${c.awardedVendor || '<span style="color:var(--text-light);">Not awarded</span>'}</td>
                <td><span class="badge ${c.solicitationType === 'sole_source' ? 'badge-high' : ''}">${c.solicitationType}</span></td>
                <td class="amount">${c.awardedValue ? formatCurrency(c.awardedValue) : '-'}</td>
                <td>${fraudBadges || '-'}</td>
                <td>${keywords || '-'}</td>
              </tr>
            `;
          }).join('');
        }
      } catch (e) {
        console.error('Failed to load contracts:', e);
        document.querySelector('#contracts-table tbody').innerHTML = 
          `<tr><td colspan="7" class="error">Failed to load contracts: ${e.message}</td></tr>`;
      }
    }
    
    async function showContractDetail(rfpNumber) {
      try {
        const res = await fetch(`${API_BASE}/dhhs-contracts/${encodeURIComponent(rfpNumber)}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const c = data.contract;
        
        const fraudList = (c.fraudIndicators || []).map(f => `
          <div class="alert-box ${f.severity === 'high' || f.severity === 'critical' ? 'danger' : ''}" style="margin-bottom:0.5rem;">
            <strong>${severityBadge(f.severity)} ${f.type}</strong>
            <p style="font-size:0.85rem;margin-top:0.25rem;">${f.description}</p>
          </div>
        `).join('');
        
        const relatedGC = (data.relatedData?.gcAgendaItems || []).map(doc => `
          <li><a href="${doc.url}" target="_blank">${doc.title || doc.url}</a> (${doc.scraped_at})</li>
        `).join('') || '<li>No related G&C items found</li>';
        
        const relatedExp = (data.relatedData?.expenditures || []).slice(0, 10).map(e => `
          <tr><td>${e.fiscal_year}</td><td>${e.vendor_name}</td><td class="amount">${formatCurrency(e.amount)}</td></tr>
        `).join('') || '<tr><td colspan="3">No related expenditures found</td></tr>';
        
        const content = `
          <div class="detail-grid">
            <div class="detail-item"><label>RFP/RFA Number</label><div class="value">${c.rfpNumber}</div></div>
            <div class="detail-item"><label>Department</label><div class="value">${c.department}</div></div>
            <div class="detail-item"><label>Division</label><div class="value">${c.division}</div></div>
            <div class="detail-item"><label>Solicitation Type</label><div class="value"><span class="badge ${c.solicitationType === 'sole_source' ? 'badge-high' : ''}">${c.solicitationType}</span></div></div>
          </div>
          
          <h4 style="margin-top:1rem;">Award Details</h4>
          <div class="detail-grid">
            <div class="detail-item"><label>Awarded Vendor</label><div class="value">${c.awardedVendor || 'Not awarded'}</div></div>
            <div class="detail-item"><label>Vendor Code</label><div class="value">${c.awardedVendorCode || '-'}</div></div>
            <div class="detail-item"><label>Estimated Value</label><div class="value amount">${c.estimatedValue ? formatCurrency(c.estimatedValue) : '-'}</div></div>
            <div class="detail-item"><label>Awarded Value</label><div class="value amount">${c.awardedValue ? formatCurrency(c.awardedValue) : '-'}</div></div>
            <div class="detail-item"><label>G&C Approval Date</label><div class="value">${c.gcAgendaDate || '-'}</div></div>
          </div>
          
          <h4 style="margin-top:1rem;">Description</h4>
          <p style="font-size:0.9rem;background:var(--bg);padding:0.75rem;border-radius:6px;">${c.description || 'No description available'}</p>
          
          ${c.matchedKeywords?.length ? `
          <h4 style="margin-top:1rem;">Matched Keywords</h4>
          <div>${c.matchedKeywords.map(k => `<span class="badge badge-immigrant">${k}</span>`).join(' ')}</div>
          ` : ''}
          
          ${fraudList ? `
          <h4 style="margin-top:1rem;">‚ö†Ô∏è Fraud Indicators</h4>
          ${fraudList}
          ` : ''}
          
          <h4 style="margin-top:1rem;">Related G&C Agenda Items</h4>
          <ul style="font-size:0.85rem;margin-left:1rem;">${relatedGC}</ul>
          
          <h4 style="margin-top:1rem;">Related Expenditures</h4>
          <table style="font-size:0.85rem;">
            <thead><tr><th>FY</th><th>Vendor</th><th>Amount</th></tr></thead>
            <tbody>${relatedExp}</tbody>
          </table>
          
          ${c.pdfUrl ? `<p style="margin-top:1rem;"><a href="${c.pdfUrl}" target="_blank" class="btn btn-outline">View Source PDF</a></p>` : ''}
        `;
        
        openModal('provider-modal');
        document.getElementById('provider-modal-title').textContent = c.title;
        document.getElementById('provider-modal-body').innerHTML = content;
      } catch (e) {
        alert('Failed to load contract details: ' + e.message);
      }
    }
    
    async function runDHHSScraper() {
      const btn = document.getElementById('run-dhhs-scraper-btn');
      const key = getApiKey();
      if (!key) {
        alert('Admin login required to run scrapers. Go to Admin tab first.');
        return;
      }
      
      btn.disabled = true;
      btn.textContent = '‚è≥ Running...';
      
      try {
        const res = await fetch(`${API_BASE}/trigger/dhhs-contracts`, {
          method: 'POST',
          headers: getAuthHeaders()
        });
        
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || `HTTP ${res.status}`);
        }
        
        const data = await res.json();
        alert(`DHHS Contracts scraper completed!\n\nTotal: ${data.stats.total}\nImmigrant-related: ${data.stats.immigrantRelated}\nWith fraud flags: ${data.stats.withFraudIndicators}\nSaved: ${data.stats.saved}, Updated: ${data.stats.updated}`);
        loadContracts();
      } catch (e) {
        alert('Scraper failed: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîÑ Refresh Data';
      }
    }
    
    async function runCrossReferenceAnalysis() {
      const btn = document.getElementById('run-crossref-btn');
      const container = document.getElementById('crossref-results');
      const key = getApiKey();
      
      if (!key) {
        alert('Admin login required. Go to Admin tab first.');
        return;
      }
      
      btn.disabled = true;
      btn.textContent = '‚è≥ Analyzing...';
      container.innerHTML = '<div class="loading">Running cross-reference analysis...</div>';
      
      try {
        const res = await fetch(`${API_BASE}/analysis/cross-reference`, {
          headers: getAuthHeaders()
        });
        
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || `HTTP ${res.status}`);
        }
        
        const data = await res.json();
        
        // Render summary
        let html = `
          <div class="stats-grid" style="margin-bottom:1rem;">
            <div class="stat-card"><h3>Vendors Tracked</h3><div class="value">${data.summary.totalVendors}</div></div>
            <div class="stat-card"><h3>Total Contract Value</h3><div class="value amount">${formatCurrency(data.summary.totalContractValue)}</div></div>
            <div class="stat-card"><h3>Total Expenditures</h3><div class="value amount">${formatCurrency(data.summary.totalExpenditures)}</div></div>
            <div class="stat-card danger"><h3>With Discrepancies</h3><div class="value">${data.summary.vendorsWithDiscrepancies}</div></div>
          </div>
        `;
        
        // Render vendor details
        html += '<h4>Vendor Analysis</h4>';
        html += '<table><thead><tr><th>Vendor</th><th>Contracts</th><th>Contract Value</th><th>Expenditures</th><th>Expenditure Total</th><th>Issues</th></tr></thead><tbody>';
        
        for (const [vendor, info] of Object.entries(data.vendors)) {
          const hasIssues = info.discrepancies.length > 0 || info.fraudIndicators.length > 0;
          html += `
            <tr style="${hasIssues ? 'background:#fff5f5;' : ''}">
              <td><strong>${vendor}</strong></td>
              <td>${info.dhhsContracts}</td>
              <td class="amount">${formatCurrency(info.dhhsContractValue)}</td>
              <td>${info.expenditures}</td>
              <td class="amount">${formatCurrency(info.expenditureTotal)}</td>
              <td>
                ${info.discrepancies.map(d => `<div class="badge badge-high" style="display:block;margin-bottom:0.25rem;">${d}</div>`).join('')}
                ${info.fraudIndicators.slice(0, 3).map(f => `<div class="badge badge-medium" style="display:block;margin-bottom:0.25rem;font-size:0.65rem;">${f}</div>`).join('')}
              </td>
            </tr>
          `;
        }
        
        html += '</tbody></table>';
        container.innerHTML = html;
      } catch (e) {
        container.innerHTML = `<div class="error">Analysis failed: ${e.message}</div>`;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Run Analysis';
      }
    }
    
    // ==========================================
    // End DHHS Contracts Functions
    // ==========================================

    // ==========================================
    // DAS Bids Functions
    // ==========================================
    
    async function loadDASBids() {
      const immigrantOnly = document.getElementById('das-immigrant-filter')?.checked || false;
      const fraudOnly = document.getElementById('das-fraud-filter')?.checked || false;
      
      try {
        const params = new URLSearchParams();
        if (immigrantOnly) params.append('immigrant_related', 'true');
        if (fraudOnly) params.append('with_fraud_indicators', 'true');
        
        const res = await fetch(`${API_BASE}/das-bids?${params}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        
        // Update stats
        document.getElementById('das-total').textContent = data.stats.total;
        document.getElementById('das-immigrant').textContent = data.stats.immigrantRelated;
        document.getElementById('das-fraud').textContent = data.stats.withFraudIndicators;
        document.getElementById('das-value').textContent = formatCurrency(data.stats.totalValue);
        
        // Render bids table
        const tbody = document.querySelector('#das-bids-table tbody');
        if (data.bids.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--text-light);">No bids found.</td></tr>';
        } else {
          tbody.innerHTML = data.bids.map(b => {
            const fraudBadges = (b.fraudIndicators || []).map(f => 
              `<span class="badge badge-${f.severity}" title="${f.description}">${f.type}</span>`
            ).join(' ');
            
            return `
              <tr>
                <td class="clickable">${b.bidNumber}</td>
                <td>${b.title}</td>
                <td>${b.department}</td>
                <td>${b.awardedVendor || '<span style="color:var(--text-light);">-</span>'}</td>
                <td><span class="badge ${b.bidType === 'sole_source' ? 'badge-high' : ''}">${b.bidType}</span></td>
                <td><span class="badge badge-${b.status === 'awarded' ? 'resolved' : 'open'}">${b.status}</span></td>
                <td class="amount">${b.awardedValue ? formatCurrency(b.awardedValue) : '-'}</td>
                <td>${fraudBadges || '-'}</td>
              </tr>
            `;
          }).join('');
        }
      } catch (e) {
        console.error('Failed to load DAS bids:', e);
        document.querySelector('#das-bids-table tbody').innerHTML = 
          `<tr><td colspan="8" class="error">Failed to load bids: ${e.message}</td></tr>`;
      }
    }
    
    async function runDASScraper() {
      const btn = document.getElementById('run-das-scraper-btn');
      const key = getApiKey();
      if (!key) {
        alert('Admin login required to run scrapers. Go to Admin tab first.');
        return;
      }
      
      btn.disabled = true;
      btn.textContent = '‚è≥ Running...';
      
      try {
        const res = await fetch(`${API_BASE}/trigger/das-bids`, {
          method: 'POST',
          headers: getAuthHeaders()
        });
        
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || `HTTP ${res.status}`);
        }
        
        const data = await res.json();
        alert(`DAS Bids scraper completed!\n\nTotal: ${data.stats.total}\nImmigrant-related: ${data.stats.immigrantRelated}\nWith fraud flags: ${data.stats.withFraudIndicators}`);
        loadDASBids();
      } catch (e) {
        alert('Scraper failed: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîÑ Refresh';
      }
    }
    
    // ==========================================
    // Federal Awards (SAM.gov) Functions
    // ==========================================
    
    async function loadFederalAwards() {
      const immigrantOnly = document.getElementById('federal-immigrant-filter')?.checked || false;
      const fraudOnly = document.getElementById('federal-fraud-filter')?.checked || false;
      
      try {
        const params = new URLSearchParams();
        if (immigrantOnly) params.append('immigrant_related', 'true');
        if (fraudOnly) params.append('with_fraud_indicators', 'true');
        
        const res = await fetch(`${API_BASE}/sam-gov?${params}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        
        // Update stats
        document.getElementById('federal-total').textContent = data.stats.total;
        document.getElementById('federal-immigrant').textContent = data.stats.immigrantRelated;
        document.getElementById('federal-fraud').textContent = data.stats.withFraudIndicators;
        document.getElementById('federal-amount').textContent = formatCurrency(data.stats.totalAmount);
        
        // Render recipient summary cards
        const recipientSummary = document.getElementById('federal-recipient-summary');
        const recipients = Object.entries(data.stats.byRecipient).sort((a, b) => b[1].totalAmount - a[1].totalAmount);
        
        if (recipients.length === 0) {
          recipientSummary.innerHTML = '<p style="color:var(--text-light);">No federal awards found.</p>';
        } else {
          recipientSummary.innerHTML = recipients.map(([recipient, info]) => `
            <div class="source-card" style="border-left: 3px solid #3182ce;">
              <h4>${recipient}</h4>
              <div style="font-size:0.85rem;">
                <div><strong>Awards:</strong> ${info.count}</div>
                <div><strong>Total Amount:</strong> <span class="amount">${formatCurrency(info.totalAmount)}</span></div>
              </div>
            </div>
          `).join('');
        }
        
        // Render awards table
        const tbody = document.querySelector('#federal-awards-table tbody');
        if (data.contracts.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-light);">No federal awards found.</td></tr>';
        } else {
          tbody.innerHTML = data.contracts.map(c => {
            const fraudBadges = (c.fraudIndicators || []).map(f => 
              `<span class="badge badge-${f.severity}" title="${f.description}">${f.type}</span>`
            ).join(' ');
            
            return `
              <tr>
                <td class="clickable">${c.awardId}</td>
                <td>${c.title}</td>
                <td>${c.recipientName}</td>
                <td>${c.awardingSubAgency || c.awardingAgency}</td>
                <td><span class="badge">${c.awardType}</span></td>
                <td class="amount">${formatCurrency(c.awardAmount)}</td>
                <td>${fraudBadges || '-'}</td>
              </tr>
            `;
          }).join('');
        }
      } catch (e) {
        console.error('Failed to load federal awards:', e);
        document.querySelector('#federal-awards-table tbody').innerHTML = 
          `<tr><td colspan="7" class="error">Failed to load awards: ${e.message}</td></tr>`;
      }
    }
    
    async function runSAMScraper() {
      const btn = document.getElementById('run-sam-scraper-btn');
      const key = getApiKey();
      if (!key) {
        alert('Admin login required to run scrapers. Go to Admin tab first.');
        return;
      }
      
      btn.disabled = true;
      btn.textContent = '‚è≥ Running...';
      
      try {
        const res = await fetch(`${API_BASE}/trigger/sam-gov`, {
          method: 'POST',
          headers: getAuthHeaders()
        });
        
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || `HTTP ${res.status}`);
        }
        
        const data = await res.json();
        alert(`SAM.gov scraper completed!\n\nTotal: ${data.stats.total}\nTotal Federal Amount: ${formatCurrency(data.stats.totalFederalAmount)}\nImmigrant-related: ${data.stats.immigrantRelated}`);
        loadFederalAwards();
      } catch (e) {
        alert('Scraper failed: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîÑ Refresh';
      }
    }
    
    // ==========================================
    // FAC Audits Functions
    // ==========================================
    
    async function loadFACAudits() {
      const refugeeOnly = document.getElementById('fac-refugee-filter')?.checked || false;
      const fraudOnly = document.getElementById('fac-fraud-filter')?.checked || false;
      
      try {
        const params = new URLSearchParams();
        if (refugeeOnly) params.append('refugee_related', 'true');
        if (fraudOnly) params.append('with_fraud_indicators', 'true');
        
        const res = await fetch(`${API_BASE}/fac-audits?${params}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        
        // Update stats
        document.getElementById('fac-total').textContent = data.stats.total;
        document.getElementById('fac-refugee').textContent = data.stats.refugeeRelated || '-';
        document.getElementById('fac-findings').textContent = data.stats.withFindings;
        document.getElementById('fac-fraud').textContent = data.stats.withFraudIndicators;
        
        // Render auditee summary cards
        const auditeeSummary = document.getElementById('fac-auditee-summary');
        const auditees = Object.entries(data.stats.byAuditee || {}).sort((a, b) => b[1].totalExpended - a[1].totalExpended);
        
        if (auditees.length === 0) {
          auditeeSummary.innerHTML = '<p style="color:var(--text-light);">No audits found. Run the FAC scraper to fetch data.</p>';
        } else {
          auditeeSummary.innerHTML = auditees.map(([auditee, info]) => `
            <div class="source-card" style="border-left: 3px solid ${info.hasFraudFlags ? 'var(--danger)' : '#38a169'};">
              <h4>${auditee}</h4>
              <div style="font-size:0.85rem;">
                <div><strong>Audits:</strong> ${info.count}</div>
                <div><strong>Total Expended:</strong> <span class="amount">${formatCurrency(info.totalExpended)}</span></div>
                ${info.hasFraudFlags ? '<div><span class="badge badge-high">HAS FRAUD FLAGS</span></div>' : ''}
              </div>
            </div>
          `).join('');
        }
        
        // Render audits table
        const tbody = document.querySelector('#fac-audits-table tbody');
        if (data.awards.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-light);">No audits found.</td></tr>';
        } else {
          tbody.innerHTML = data.awards.map(r => {
            const fraudBadges = (r.fraudIndicators || []).map(f => 
              `<span class="badge badge-${f.severity}" title="${f.description}">${f.type}</span>`
            ).join(' ');
            
            return `
              <tr onclick="showFACDetail('${r.reportId}')" style="cursor:pointer;">
                <td class="clickable">${r.auditeeName}</td>
                <td>${r.auditYear}</td>
                <td class="amount">${formatCurrency(r.totalAmountExpended)}</td>
                <td class="amount">${formatCurrency(r.refugeeProgramExpenditures)}</td>
                <td>${r.hasMaterialWeakness ? '<span class="badge badge-high">YES</span>' : '-'}</td>
                <td>${r.findings?.length || 0}</td>
                <td>${fraudBadges || '-'}</td>
              </tr>
            `;
          }).join('');
        }
      } catch (e) {
        console.error('Failed to load FAC audits:', e);
        document.querySelector('#fac-audits-table tbody').innerHTML = 
          `<tr><td colspan="7" class="error">Failed to load audits: ${e.message}</td></tr>`;
      }
    }
    
    async function showFACDetail(reportId) {
      try {
        const res = await fetch(`${API_BASE}/fac-audits/${encodeURIComponent(reportId)}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const r = data.record;
        
        const findingsList = (r.findings || []).map(f => `
          <div class="alert-box ${f.is_questioned_costs || f.is_material_weakness ? 'danger' : ''}" style="margin-bottom:0.5rem;">
            <strong>Finding ${f.reference_number}</strong>
            <p style="font-size:0.8rem;margin-top:0.25rem;">
              ${f.is_material_weakness ? '<span class="badge badge-high">Material Weakness</span> ' : ''}
              ${f.is_significant_deficiency ? '<span class="badge badge-medium">Significant Deficiency</span> ' : ''}
              ${f.is_questioned_costs ? '<span class="badge badge-high">Questioned Costs</span> ' : ''}
              ${f.is_repeat_finding ? '<span class="badge badge-medium">Repeat Finding</span> ' : ''}
            </p>
          </div>
        `).join('') || '<p style="color:var(--text-light);">No findings</p>';
        
        const fraudList = (r.fraudIndicators || []).map(f => `
          <div class="alert-box ${f.severity === 'high' || f.severity === 'critical' ? 'danger' : ''}" style="margin-bottom:0.5rem;">
            <strong>${severityBadge(f.severity)} ${f.type}</strong>
            <p style="font-size:0.85rem;margin-top:0.25rem;">${f.description}</p>
          </div>
        `).join('');
        
        const content = `
          <div class="detail-grid">
            <div class="detail-item"><label>Report ID</label><div class="value">${r.reportId}</div></div>
            <div class="detail-item"><label>Audit Year</label><div class="value">${r.auditYear}</div></div>
            <div class="detail-item"><label>Location</label><div class="value">${r.auditeeCity}, ${r.auditeeState}</div></div>
            <div class="detail-item"><label>Entity Type</label><div class="value">${r.entityType || '-'}</div></div>
          </div>
          
          <h4 style="margin-top:1rem;">Financial Summary</h4>
          <div class="detail-grid">
            <div class="detail-item"><label>Total Federal Expended</label><div class="value amount">${formatCurrency(r.totalAmountExpended)}</div></div>
            <div class="detail-item"><label>Refugee Program Expended</label><div class="value amount">${formatCurrency(r.refugeeProgramExpenditures)}</div></div>
            <div class="detail-item"><label>Low Risk Auditee</label><div class="value">${r.isLowRisk ? '<span class="badge badge-low">Yes</span>' : '<span class="badge badge-medium">No</span>'}</div></div>
            <div class="detail-item"><label>Auditor</label><div class="value">${r.auditorFirm || '-'}</div></div>
          </div>
          
          <h4 style="margin-top:1rem;">Audit Issues</h4>
          <div class="detail-grid">
            <div class="detail-item"><label>Material Weakness</label><div class="value">${r.hasMaterialWeakness ? '<span class="badge badge-high">YES</span>' : 'No'}</div></div>
            <div class="detail-item"><label>Significant Deficiency</label><div class="value">${r.hasSignificantDeficiency ? '<span class="badge badge-medium">YES</span>' : 'No'}</div></div>
            <div class="detail-item"><label>Material Noncompliance</label><div class="value">${r.hasMaterialNoncompliance ? '<span class="badge badge-high">YES</span>' : 'No'}</div></div>
            <div class="detail-item"><label>Going Concern</label><div class="value">${r.hasGoingConcern ? '<span class="badge badge-critical">YES</span>' : 'No'}</div></div>
          </div>
          
          <h4 style="margin-top:1rem;">Audit Findings (${r.findings?.length || 0})</h4>
          ${findingsList}
          
          ${fraudList ? `
          <h4 style="margin-top:1rem;">‚ö†Ô∏è Fraud Indicators</h4>
          ${fraudList}
          ` : ''}
          
          ${r.matchedKeywords?.length ? `
          <h4 style="margin-top:1rem;">Matched Keywords</h4>
          <div>${r.matchedKeywords.map(k => `<span class="badge badge-immigrant">${k}</span>`).join(' ')}</div>
          ` : ''}
          
          <p style="margin-top:1rem;"><a href="${r.sourceUrl}" target="_blank" class="btn btn-outline">View on FAC.gov</a></p>
        `;
        
        openModal('provider-modal');
        document.getElementById('provider-modal-title').textContent = r.auditeeName;
        document.getElementById('provider-modal-body').innerHTML = content;
      } catch (e) {
        alert('Failed to load audit details: ' + e.message);
      }
    }
    
    async function runFACScraper() {
      const btn = document.getElementById('run-fac-scraper-btn');
      const key = getApiKey();
      if (!key) {
        alert('Admin login required to run scrapers. Go to Admin tab first.');
        return;
      }
      
      btn.disabled = true;
      btn.textContent = '‚è≥ Running...';
      
      try {
        const res = await fetch(`${API_BASE}/trigger/fac-audits`, {
          method: 'POST',
          headers: getAuthHeaders()
        });
        
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || `HTTP ${res.status}`);
        }
        
        const data = await res.json();
        alert(`FAC scraper completed!\n\nTotal Audits: ${data.stats.total}\nRefugee-Related: ${data.stats.refugeeRelated || '-'}\nWith Findings: ${data.stats.withFindings}\nWith Fraud Flags: ${data.stats.withFraudIndicators}`);
        loadFACAudits();
      } catch (e) {
        alert('Scraper failed: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîÑ Refresh';
      }
    }
    
    // ==========================================
    // HHS TAGGS Functions
    // ==========================================
    
    async function loadTAGGSAwards() {
      const refugeeOnly = document.getElementById('taggs-refugee-filter')?.checked || false;
      const childcareOnly = document.getElementById('taggs-childcare-filter')?.checked || false;
      
      try {
        const params = new URLSearchParams();
        if (refugeeOnly) params.append('refugee_related', 'true');
        if (childcareOnly) params.append('childcare_related', 'true');
        
        const res = await fetch(`${API_BASE}/hhs-taggs?${params}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        
        // Update stats
        document.getElementById('taggs-total').textContent = data.stats.total;
        document.getElementById('taggs-refugee').textContent = data.stats.refugeeRelated || '-';
        document.getElementById('taggs-childcare').textContent = data.stats.childcareRelated;
        document.getElementById('taggs-amount').textContent = formatCurrency(data.stats.totalAwardAmount);
        
        // Render program summary cards
        const programSummary = document.getElementById('taggs-program-summary');
        const programs = Object.entries(data.stats.byProgram || {}).sort((a, b) => b[1].amount - a[1].amount);
        
        if (programs.length === 0) {
          programSummary.innerHTML = '<p style="color:var(--text-light);">No awards found. Run the TAGGS scraper to fetch data.</p>';
        } else {
          const programColors = {
            '93.566': '#38a169',
            '93.567': '#38a169',
            '93.576': '#38a169',
            '93.575': '#3182ce',
            '93.596': '#3182ce',
          };
          programSummary.innerHTML = programs.map(([aln, info]) => `
            <div class="source-card" style="border-left: 3px solid ${programColors[aln] || '#805ad5'};">
              <h4>${aln}</h4>
              <p style="font-size:0.8rem;color:var(--text-light);margin-bottom:0.5rem;">${info.name}</p>
              <div style="font-size:0.85rem;">
                <div><strong>Awards:</strong> ${info.count}</div>
                <div><strong>Total Amount:</strong> <span class="amount">${formatCurrency(info.amount)}</span></div>
              </div>
            </div>
          `).join('');
        }
        
        // Render awards table
        const tbody = document.querySelector('#taggs-awards-table tbody');
        if (data.awards.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-light);">No awards found.</td></tr>';
        } else {
          tbody.innerHTML = data.awards.map(r => {
            const fraudBadges = (r.fraudIndicators || []).map(f => 
              `<span class="badge badge-${f.severity}" title="${f.description}">${f.type}</span>`
            ).join(' ');
            
            const categoryBadge = r.isRefugeeRelated 
              ? '<span class="badge badge-immigrant">Refugee</span>' 
              : r.isChildcareRelated 
                ? '<span class="badge badge-ccdf">Childcare</span>' 
                : '';
            
            return `
              <tr onclick="showTAGGSDetail('${r.awardId}')" style="cursor:pointer;">
                <td class="clickable">${r.recipientName}</td>
                <td><span class="badge">${r.aln}</span></td>
                <td title="${r.programName}">${r.programName.substring(0, 30)}${r.programName.length > 30 ? '...' : ''}</td>
                <td>${r.fiscalYear}</td>
                <td class="amount">${formatCurrency(r.awardAmount)}</td>
                <td>${r.actionType} ${categoryBadge}</td>
                <td>${fraudBadges || '-'}</td>
              </tr>
            `;
          }).join('');
        }
      } catch (e) {
        console.error('Failed to load TAGGS awards:', e);
        document.querySelector('#taggs-awards-table tbody').innerHTML = 
          `<tr><td colspan="7" class="error">Failed to load awards: ${e.message}</td></tr>`;
      }
    }
    
    async function showTAGGSDetail(awardId) {
      try {
        const res = await fetch(`${API_BASE}/hhs-taggs/${encodeURIComponent(awardId)}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const r = data.record;
        
        const fraudList = (r.fraudIndicators || []).map(f => `
          <div class="alert-box ${f.severity === 'high' || f.severity === 'critical' ? 'danger' : ''}" style="margin-bottom:0.5rem;">
            <strong>${severityBadge(f.severity)} ${f.type}</strong>
            <p style="font-size:0.85rem;margin-top:0.25rem;">${f.description}</p>
          </div>
        `).join('');
        
        const relatedDHHS = (data.relatedData?.dhhsContracts || []).map(c => `
          <tr><td>${c.rfpNumber}</td><td>${c.title}</td><td class="amount">${formatCurrency(c.awardedValue)}</td></tr>
        `).join('') || '<tr><td colspan="3" style="color:var(--text-light);">No related state contracts found</td></tr>';
        
        const content = `
          <div class="detail-grid">
            <div class="detail-item"><label>Award ID</label><div class="value">${r.awardId}</div></div>
            <div class="detail-item"><label>Grant Number</label><div class="value">${r.grantNumber || '-'}</div></div>
            <div class="detail-item"><label>Operating Division</label><div class="value">${r.opdiv || '-'}</div></div>
            <div class="detail-item"><label>Fiscal Year</label><div class="value">${r.fiscalYear}</div></div>
          </div>
          
          <h4 style="margin-top:1rem;">Recipient</h4>
          <div class="detail-grid">
            <div class="detail-item"><label>Name</label><div class="value">${r.recipientName}</div></div>
            <div class="detail-item"><label>Location</label><div class="value">${r.recipientCity}, ${r.recipientState}</div></div>
          </div>
          
          <h4 style="margin-top:1rem;">Program Details</h4>
          <div class="detail-grid">
            <div class="detail-item"><label>ALN (CFDA)</label><div class="value"><span class="badge">${r.aln}</span></div></div>
            <div class="detail-item"><label>Program Name</label><div class="value">${r.programName}</div></div>
            <div class="detail-item"><label>Category</label><div class="value">${r.isRefugeeRelated ? '<span class="badge badge-immigrant">Refugee Program</span>' : r.isChildcareRelated ? '<span class="badge badge-ccdf">Childcare Program</span>' : r.programCategory}</div></div>
            <div class="detail-item"><label>Action Type</label><div class="value">${r.actionType}</div></div>
          </div>
          
          <h4 style="margin-top:1rem;">Award Amount</h4>
          <div class="stat-card" style="display:inline-block;">
            <div class="value amount" style="font-size:2rem;">${formatCurrency(r.awardAmount)}</div>
          </div>
          
          ${r.projectTitle ? `
          <h4 style="margin-top:1rem;">Project Title</h4>
          <p style="font-size:0.9rem;background:var(--bg);padding:0.75rem;border-radius:6px;">${r.projectTitle}</p>
          ` : ''}
          
          ${fraudList ? `
          <h4 style="margin-top:1rem;">‚ö†Ô∏è Fraud Indicators</h4>
          ${fraudList}
          ` : ''}
          
          <h4 style="margin-top:1rem;">Related State Contracts</h4>
          <table style="font-size:0.85rem;">
            <thead><tr><th>RFP/RFA</th><th>Title</th><th>Value</th></tr></thead>
            <tbody>${relatedDHHS}</tbody>
          </table>
          
          ${r.matchedKeywords?.length ? `
          <h4 style="margin-top:1rem;">Matched Keywords</h4>
          <div>${r.matchedKeywords.map(k => `<span class="badge badge-immigrant">${k}</span>`).join(' ')}</div>
          ` : ''}
          
          <p style="margin-top:1rem;"><a href="${r.sourceUrl}" target="_blank" class="btn btn-outline">View on TAGGS</a></p>
        `;
        
        openModal('provider-modal');
        document.getElementById('provider-modal-title').textContent = `${r.aln} - ${r.programName}`;
        document.getElementById('provider-modal-body').innerHTML = content;
      } catch (e) {
        alert('Failed to load award details: ' + e.message);
      }
    }
    
    async function runTAGGSScraper() {
      const btn = document.getElementById('run-taggs-scraper-btn');
      const key = getApiKey();
      if (!key) {
        alert('Admin login required to run scrapers. Go to Admin tab first.');
        return;
      }
      
      btn.disabled = true;
      btn.textContent = '‚è≥ Running...';
      
      try {
        const res = await fetch(`${API_BASE}/trigger/hhs-taggs`, {
          method: 'POST',
          headers: getAuthHeaders()
        });
        
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || `HTTP ${res.status}`);
        }
        
        const data = await res.json();
        alert(`HHS TAGGS scraper completed!\n\nTotal Awards: ${data.stats.total}\nRefugee Programs: ${data.stats.refugeeRelated || '-'}\nChildcare Programs: ${data.stats.childcareRelated}\nTotal Amount: ${formatCurrency(data.stats.totalAwardAmount)}`);
        loadTAGGSAwards();
      } catch (e) {
        alert('Scraper failed: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîÑ Refresh';
      }
    }
    
    // ==========================================
    // Nonprofits (Charitable Trusts) Functions
    // ==========================================
    
    async function loadNonprofits() {
      const refugeeOnly = document.getElementById('nonprofit-refugee-filter')?.checked || false;
      const fraudOnly = document.getElementById('nonprofit-fraud-filter')?.checked || false;
      
      try {
        const params = new URLSearchParams();
        if (refugeeOnly) params.append('refugee_providers', 'true');
        if (fraudOnly) params.append('with_fraud_indicators', 'true');
        
        const res = await fetch(`${API_BASE}/charitable-trusts?${params}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        
        // Update stats
        document.getElementById('nonprofit-total').textContent = data.stats.total;
        document.getElementById('nonprofit-refugee').textContent = data.stats.refugeeProviders;
        document.getElementById('nonprofit-fraud').textContent = data.stats.withFraudIndicators;
        document.getElementById('nonprofit-grants').textContent = formatCurrency(data.stats.totalGovGrants);
        
        // Render nonprofit cards
        const cardsContainer = document.getElementById('nonprofit-cards');
        if (data.trusts.length === 0) {
          cardsContainer.innerHTML = '<p style="color:var(--text-light);">No nonprofits found.</p>';
        } else {
          cardsContainer.innerHTML = data.trusts.map(t => {
            const form990 = t.form990Data;
            const overheadRatio = form990 ? (((form990.administrativeExpenses || 0) + (form990.fundraisingExpenses || 0)) / form990.totalExpenses * 100).toFixed(1) : '-';
            const fraudCount = (t.fraudIndicators || []).filter(f => f.type !== 'government_funding_summary').length;
            
            return `
              <div class="source-card" style="border-left: 3px solid ${fraudCount > 0 ? 'var(--danger)' : '#805ad5'};">
                <h4>${t.organizationName}</h4>
                <div style="font-size:0.8rem; color:var(--text-light); margin-bottom:0.5rem;">
                  ${t.city ? `${t.city}, ${t.state}` : ''} ${t.ein ? `| EIN: ${t.ein}` : ''}
                </div>
                ${form990 ? `
                <div style="font-size:0.85rem;">
                  <div><strong>Revenue:</strong> <span class="amount">${formatCurrency(form990.totalRevenue)}</span></div>
                  <div><strong>Gov Grants:</strong> <span class="amount">${formatCurrency(form990.governmentGrants || 0)}</span></div>
                  <div><strong>Overhead:</strong> ${overheadRatio}%</div>
                  ${form990.executiveCompensation?.length ? `
                  <div><strong>Top Exec:</strong> ${form990.executiveCompensation[0].title} - ${formatCurrency(form990.executiveCompensation[0].compensation)}</div>
                  ` : ''}
                </div>
                ` : '<div style="color:var(--text-light);">No Form 990 data</div>'}
                ${fraudCount > 0 ? `
                <div style="margin-top:0.5rem;">
                  <span class="badge badge-high">${fraudCount} fraud flag${fraudCount > 1 ? 's' : ''}</span>
                </div>
                ` : ''}
              </div>
            `;
          }).join('');
        }
        
        // Render nonprofit table
        const tbody = document.querySelector('#nonprofit-table tbody');
        if (data.trusts.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--text-light);">No nonprofits found.</td></tr>';
        } else {
          tbody.innerHTML = data.trusts.map(t => {
            const form990 = t.form990Data;
            const programRatio = form990 && form990.totalExpenses ? ((form990.programExpenses || 0) / form990.totalExpenses * 100).toFixed(1) : '-';
            const overheadRatio = form990 && form990.totalExpenses ? (((form990.administrativeExpenses || 0) + (form990.fundraisingExpenses || 0)) / form990.totalExpenses * 100).toFixed(1) : '-';
            const topExec = form990?.executiveCompensation?.[0];
            const fraudBadges = (t.fraudIndicators || []).filter(f => f.type !== 'government_funding_summary').map(f => 
              `<span class="badge badge-${f.severity}" title="${f.description}">${f.type}</span>`
            ).join(' ');
            
            return `
              <tr>
                <td><strong>${t.organizationName}</strong></td>
                <td class="amount">${form990 ? formatCurrency(form990.totalRevenue) : '-'}</td>
                <td class="amount">${form990 ? formatCurrency(form990.governmentGrants || 0) : '-'}</td>
                <td class="amount">${form990 ? formatCurrency(form990.totalExpenses) : '-'}</td>
                <td>${programRatio}%</td>
                <td class="${parseFloat(overheadRatio) > 25 ? 'badge-high' : ''}">${overheadRatio}%</td>
                <td class="amount">${topExec ? formatCurrency(topExec.compensation) : '-'}</td>
                <td>${fraudBadges || '-'}</td>
              </tr>
            `;
          }).join('');
        }
      } catch (e) {
        console.error('Failed to load nonprofits:', e);
        document.querySelector('#nonprofit-table tbody').innerHTML = 
          `<tr><td colspan="8" class="error">Failed to load nonprofits: ${e.message}</td></tr>`;
      }
    }
    
    async function runTrustsScraper() {
      const btn = document.getElementById('run-trusts-scraper-btn');
      const key = getApiKey();
      if (!key) {
        alert('Admin login required to run scrapers. Go to Admin tab first.');
        return;
      }
      
      btn.disabled = true;
      btn.textContent = '‚è≥ Running...';
      
      try {
        const res = await fetch(`${API_BASE}/trigger/charitable-trusts`, {
          method: 'POST',
          headers: getAuthHeaders()
        });
        
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || `HTTP ${res.status}`);
        }
        
        const data = await res.json();
        alert(`Charitable Trusts scraper completed!\n\nTotal: ${data.stats.total}\nRefugee Providers: ${data.stats.refugeeProviders}\nWith fraud flags: ${data.stats.withFraudIndicators}`);
        loadNonprofits();
      } catch (e) {
        alert('Scraper failed: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîÑ Refresh';
      }
    }
    
    // ==========================================
    // End New Scraper Functions
    // ==========================================

    async function confirmInitDb() { if (prompt('Type RESET:')==='RESET') await fetch(`${API_BASE}/admin/init-db`, { method: 'POST', headers: getAuthHeaders() }); }
    async function seedSampleData() { await fetch(`${API_BASE}/admin/seed-sample-data`, { method: 'POST', headers: getAuthHeaders() }); }
    async function viewDbInfo() {
      const url = `${API_BASE}/admin/db-info`;
      console.log(`Checking connection to: ${url}`);
      const el = document.getElementById('db-info-result');
      if (!el) return console.error('db-info-result element not found');
      el.innerHTML = 'Connecting...';
      try {
        const headers = getAuthHeaders();
        console.log('Using headers:', Object.keys(headers).join(', '));
        
        const res = await fetch(url, { headers });
        console.log('Response status:', res.status);
        console.log('Response content-type:', res.headers.get('content-type'));
        
        const contentType = res.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || data.message || `HTTP ${res.status}`);
          el.innerHTML = `<pre style="font-size:0.6rem;background:#eee;padding:0.5rem;border-radius:4px;overflow:auto;max-height:200px;">${JSON.stringify(data,null,2)}</pre>`;
        } else {
          const text = await res.text();
          console.error('Non-JSON response (first 500 chars):', text.slice(0, 500));
          throw new Error(`Server returned HTML instead of JSON (HTTP ${res.status}). This usually means the API route was not found and the server returned a 404 page. Check the console for more info.`);
        }
      } catch (e) {
        console.error('Connection check error:', e);
        el.innerHTML = `<div style="color:var(--danger);font-size:0.75rem;margin-top:0.5rem;padding:0.5rem;background:#fff5f5;border:1px solid #feb2b2;border-radius:4px;">${e.message}</div>`;
      }
    }
  </script>
</body>
</html>
