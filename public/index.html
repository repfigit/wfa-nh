<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NH Childcare Payments Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #1a365d;
      --primary-light: #2c5282;
      --secondary: #718096;
      --success: #38a169;
      --warning: #d69e2e;
      --danger: #e53e3e;
      --critical: #9b2c2c;
      --bg: #f7fafc;
      --card-bg: #ffffff;
      --text: #2d3748;
      --text-light: #718096;
      --border: #e2e8f0;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }
    
    header {
      background: var(--primary);
      color: white;
      padding: 1rem 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    header h1 { font-size: 1.5rem; font-weight: 600; }
    header p { opacity: 0.9; font-size: 0.875rem; }
    
    .header-subtitle {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.25rem;
    }
    
    .header-badge {
      background: var(--danger);
      padding: 0.15rem 0.5rem;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    nav {
      background: var(--primary-light);
      padding: 0.5rem 2rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    nav a {
      color: white;
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      font-size: 0.875rem;
      transition: background 0.2s;
    }
    
    nav a:hover, nav a.active { background: rgba(255,255,255,0.2); }
    
    main { max-width: 1400px; margin: 0 auto; padding: 2rem; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background: var(--card-bg);
      padding: 1.25rem;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .stat-card h3 {
      font-size: 0.7rem;
      text-transform: uppercase;
      color: var(--text-light);
      margin-bottom: 0.5rem;
      letter-spacing: 0.5px;
    }
    
    .stat-card .value { font-size: 1.75rem; font-weight: 700; color: var(--primary); }
    .stat-card.warning .value { color: var(--warning); }
    .stat-card.danger .value { color: var(--danger); }
    .stat-card.highlight { border-left: 4px solid var(--danger); }
    
    .card {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
    }
    
    .card-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .card-header h2 { font-size: 1.125rem; font-weight: 600; }
    .card-body { padding: 1.5rem; }
    
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .chart-container { position: relative; height: 250px; }
    
    table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
    th, td { text-align: left; padding: 0.75rem; border-bottom: 1px solid var(--border); }
    th { font-size: 0.7rem; text-transform: uppercase; color: var(--text-light); font-weight: 600; }
    tr:hover { background: var(--bg); }
    
    .badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.7rem;
      font-weight: 500;
    }
    
    .badge-low { background: #c6f6d5; color: #276749; }
    .badge-medium { background: #fefcbf; color: #975a16; }
    .badge-high { background: #fed7d7; color: #c53030; }
    .badge-critical { background: #9b2c2c; color: white; }
    .badge-open { background: #bee3f8; color: #2c5282; }
    .badge-investigating { background: #fefcbf; color: #975a16; }
    .badge-resolved { background: #c6f6d5; color: #276749; }
    .badge-dismissed { background: #e2e8f0; color: #4a5568; }
    .badge-immigrant { background: #805ad5; color: white; }
    .badge-ccdf { background: #2c5282; color: white; }
    
    .amount { font-family: 'SF Mono', Monaco, Consolas, monospace; font-weight: 500; }
    
    .search-box { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .search-box input, .search-box select {
      padding: 0.6rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.875rem;
    }
    .search-box input { flex: 1; min-width: 200px; }
    
    .btn {
      padding: 0.6rem 1rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: background 0.2s;
    }
    .btn:hover { background: var(--primary-light); }
    .btn-sm { padding: 0.4rem 0.75rem; font-size: 0.75rem; }
    .btn-outline {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }
    .btn-outline:hover { background: var(--primary); color: white; }
    
    .fraud-summary { display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap; }
    .fraud-count { display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.8rem; }
    
    .data-sources {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
    }
    
    .source-card {
      background: var(--bg);
      padding: 1rem;
      border-radius: 6px;
      border: 1px solid var(--border);
    }
    .source-card h4 { font-size: 0.875rem; margin-bottom: 0.5rem; }
    .source-card a { color: var(--primary); font-size: 0.75rem; word-break: break-all; }
    
    .loading { text-align: center; padding: 2rem; color: var(--text-light); }
    .error { background: #fed7d7; color: #c53030; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; }
    
    .view { display: none; }
    .view.active { display: block; }
    
    .clickable { cursor: pointer; color: var(--primary); }
    .clickable:hover { text-decoration: underline; }
    
    .flag-icon { color: var(--danger); margin-right: 0.25rem; }
    .warning-icon { color: var(--warning); }
    
    .capacity-warning { 
      background: #fed7d7; 
      color: #c53030; 
      padding: 0.15rem 0.4rem; 
      border-radius: 4px; 
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      overflow-y: auto;
      padding: 2rem;
    }
    .modal.active { display: flex; justify-content: center; align-items: flex-start; }
    .modal-content {
      background: white;
      border-radius: 12px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .modal-header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background: white;
      z-index: 1;
    }
    .modal-header h3 { font-size: 1.125rem; }
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-light);
      line-height: 1;
    }
    .modal-close:hover { color: var(--text); }
    .modal-body { padding: 1.5rem; }
    
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .detail-item label {
      display: block;
      font-size: 0.7rem;
      text-transform: uppercase;
      color: var(--text-light);
      margin-bottom: 0.25rem;
    }
    .detail-item .value { font-weight: 500; }
    
    .alert-box {
      background: #fef5e7;
      border: 1px solid #d69e2e;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .alert-box.danger {
      background: #fed7d7;
      border-color: #c53030;
    }
    .alert-box h4 { 
      font-size: 0.875rem; 
      color: var(--warning);
      margin-bottom: 0.5rem;
    }
    .alert-box.danger h4 { color: var(--danger); }
    
    footer {
      text-align: center;
      padding: 2rem;
      color: var(--text-light);
      font-size: 0.875rem;
    }
    footer a { color: var(--primary); }
    
    /* API Key Configuration */
    .api-key-input-group {
      display: flex;
      gap: 0.5rem;
    }
    .api-key-input-group input {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.875rem;
      font-family: 'SF Mono', Monaco, Consolas, monospace;
    }
    
    /* Progress Bar Styles */
    .progress-status {
      font-size: 0.75rem;
      padding: 0.2rem 0.5rem;
      border-radius: 9999px;
    }
    .progress-status.running { background: #bee3f8; color: #2c5282; }
    .progress-status.completed { background: #c6f6d5; color: #276749; }
    .progress-status.failed { background: #fed7d7; color: #c53030; }
    .progress-status.pending { background: #e2e8f0; color: #4a5568; }
    .progress-bar-bg {
      width: 100%;
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--primary-light));
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    
    /* Scraper Grid */
    .scraper-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .scraper-card {
      background: var(--card-bg);
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 1rem;
    }
    .scraper-card h4 {
      font-size: 0.875rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .scraper-card h4 .icon {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
    }
    .scraper-card p {
      font-size: 0.75rem;
      color: var(--text-light);
      margin-bottom: 0.75rem;
    }
    .scraper-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    /* Scraper Progress Bar */
    .scraper-progress {
      display: none;
      margin-top: 0.75rem;
    }
    .scraper-progress.active {
      display: block;
    }
    .progress-bar-container {
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--success), var(--primary));
      background-size: 200% 100%;
      animation: progress-animation 1.5s linear infinite;
      width: 100%;
      border-radius: 4px;
    }
    .progress-bar.complete {
      background: var(--success);
      animation: none;
    }
    .progress-bar.error {
      background: var(--danger);
      animation: none;
    }
    @keyframes progress-animation {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .progress-status {
      font-size: 0.7rem;
      color: var(--text-light);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .progress-status .spinner {
      width: 12px;
      height: 12px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Active Jobs Panel */
    .active-jobs-panel {
      background: var(--primary);
      color: white;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    .active-jobs-panel h3 {
      font-size: 0.875rem;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .active-jobs-panel .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin-top: 1rem;
      padding: 1rem;
    }
    .filter-input {
      width: 100%;
      padding: 0.3rem;
      font-size: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 4px;
      margin-top: 0.25rem;
    }
    #source-top-scrollbar::-webkit-scrollbar { height: 8px; }
    #source-top-scrollbar::-webkit-scrollbar-track { background: var(--bg); }
    #source-top-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
    #source-top-scrollbar::-webkit-scrollbar-thumb:hover { background: #a0aec0; }
    .header-content span { font-weight: 600; margin-bottom: 4px; }
    .active-job-item {
      background: rgba(255,255,255,0.1);
      border-radius: 6px;
      padding: 0.75rem;
    }
    
    @media (max-width: 768px) {
      main { padding: 1rem; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .charts-grid { grid-template-columns: 1fr; }
      .scraper-grid { grid-template-columns: 1fr; }
      table { font-size: 0.75rem; }
      th, td { padding: 0.5rem; }
    }
  </style>
</head>
<body>
  <header>
    <h1>NH Childcare Payments Tracker</h1>
    <div class="header-subtitle">
      <span>CCDF Scholarship Payments to Daycare Providers</span>
      <span class="header-badge">CCDF Fraud Watch</span>
    </div>
  </header>
  
  <nav>
    <a href="#" class="active" data-view="dashboard">Dashboard</a>
    <a href="#" data-view="providers">Providers</a>
    <a href="#" data-view="payments">Payments</a>
    <a href="#" data-view="fraud">Fraud Indicators</a>
    <a href="#" data-view="sources">Data Sources</a>
    <a href="#" data-view="admin">Admin</a>
  </nav>
  
  <main>
    <!-- Dashboard View -->
    <div id="dashboard-view" class="view active">
      <div class="alert-box">
        <h4>Federal CCDF Fraud Context</h4>
        <p style="font-size:0.85rem;">NH receives ~$30M annually in CCDF funds. This tool tracks payments for potential fraud patterns.</p>
      </div>
      
      <div class="card" id="federal-funding-card" style="margin-bottom: 1.5rem; border-left: 4px solid #2c5282;">
        <div class="card-header">
          <h2>Federal CCDF Funding (USAspending.gov)</h2>
          <button class="btn btn-sm btn-outline" onclick="refreshFederalData()" id="refresh-federal-btn">Refresh Data</button>
        </div>
        <div class="card-body" id="federal-funding-content">
          <div class="loading">Loading...</div>
        </div>
      </div>
      
      <div class="stats-grid" id="stats-grid">
        <div class="loading">Loading statistics...</div>
      </div>
      
      <div class="charts-grid">
        <div class="card">
          <div class="card-header"><h2>Payments by City</h2></div>
          <div class="card-body">
            <div class="chart-container"><canvas id="cityChart"></canvas></div>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><h2>Fraud Indicators by Type</h2></div>
          <div class="card-body">
            <div class="chart-container"><canvas id="fraudChart"></canvas></div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h2>Top Providers by CCDF Payments</h2>
          <button class="btn btn-sm btn-outline" onclick="exportData('providers')">Export CSV</button>
        </div>
        <div class="card-body">
          <table id="top-providers">
            <thead>
              <tr><th>Provider</th><th>City</th><th>Type</th><th>Capacity</th><th>Max Children</th><th>Total Payments</th><th>Flags</th></tr>
            </thead>
            <tbody><tr><td colspan="7" class="loading">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Providers View -->
    <div id="providers-view" class="view">
      <div class="search-box">
        <input type="text" id="provider-search" placeholder="Search providers..." onkeyup="if(event.key==='Enter')searchProviders()">
        <select id="provider-filter">
          <option value="">All Providers</option>
          <option value="immigrant">Immigrant-Owned Only</option>
        </select>
        <button class="btn" onclick="searchProviders()">Search</button>
      </div>
      <div class="card">
        <div class="card-header"><h2>Childcare Providers</h2></div>
        <div class="card-body" style="overflow-x:auto;">
          <table id="providers-table">
            <thead>
              <tr><th>Name</th><th>Owner</th><th>City</th><th>Type</th><th>Capacity</th><th>Languages</th><th>Total Payments</th><th>Flags</th></tr>
            </thead>
            <tbody><tr><td colspan="8" class="loading">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Source Data Browser View -->
    <div id="sources-view" class="view">
      
      <!-- Source Metadata Cards -->
      <div class="card">
        <div class="card-header"><h2>Data Sources</h2></div>
        <div class="card-body"><div class="data-sources" id="data-sources-list"></div></div>
      </div>
    
      <!-- Source Data Browser (Combined) -->
      <div class="card">
        <div class="card-header">
           <h2>Raw Source Data</h2>
            <div style="display:flex; gap:0.5rem; align-items: center;">
              <select id="source-table-limit" style="width: auto; font-size: 0.8rem;" onchange="loadSourceTableData(true)">
                <option value="10">10 per page</option>
                <option value="20" selected>20 per page</option>
                <option value="50">50 per page</option>
                <option value="100">100 per page</option>
              </select>
              <select id="source-table-select" onchange="loadSourceTableData(true)">

               <option value="">Loading tables...</option>
             </select>
             <button class="btn btn-sm" onclick="loadSourceTableData()">Load Data</button>
           </div>
        </div>
        <div class="card-body" id="source-table-container">
          <div id="source-table-pagination-top" style="margin-bottom:0.5rem;"></div>
          <div id="source-top-scrollbar" style="overflow-x: auto; overflow-y: hidden; height: 20px; display: none;">
            <div id="source-top-scrollbar-content" style="height: 20px;"></div>
          </div>
          <div id="source-table-scroll-wrapper" style="overflow-x: auto;">
            <p style="color:var(--text-light); text-align:center;">Select a table to view raw data.</p>
          </div>
          <div id="source-table-pagination-bottom" style="margin-top:0.5rem;"></div>
        </div>
      </div>
    </div>

    <!-- Payments View -->
    <div id="payments-view" class="view">
      <div class="search-box">
        <select id="payment-year-filter" onchange="loadPayments()">
          <option value="">All Years</option>
          <option value="2024">FY 2024</option>
          <option value="2023">FY 2023</option>
        </select>
      </div>
      <div class="card">
        <div class="card-header"><h2>CCDF Scholarship Payments</h2></div>
        <div class="card-body" style="overflow-x:auto;">
          <table id="payments-table">
            <thead>
              <tr><th>Provider</th><th>Immigrant?</th><th>FY</th><th>Month</th><th>Amount</th><th>Children</th><th>$/Child</th><th>Funding</th></tr>
            </thead>
            <tbody><tr><td colspan="8" class="loading">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Fraud Indicators View -->
    <div id="fraud-view" class="view">
      <div class="card">
        <div class="card-header">
          <h2>Fraud Indicators</h2>
          <div style="display:flex;gap:0.5rem;">
            <select id="fraud-severity-filter" onchange="loadFraudIndicators()"><option value="">All Severities</option><option value="critical">Critical</option><option value="high">High</option><option value="medium">Medium</option><option value="low">Low</option></select>
            <select id="fraud-status-filter" onchange="loadFraudIndicators()"><option value="">All Statuses</option><option value="open">Open</option><option value="investigating">Investigating</option><option value="resolved">Resolved</option><option value="dismissed">Dismissed</option></select>
          </div>
        </div>
        <div class="card-body" style="overflow-x:auto;">
          <table id="fraud-table">
            <thead>
              <tr><th>Severity</th><th>Type</th><th>Description</th><th>Evidence</th><th>Provider</th><th>Status</th></tr>
            </thead>
            <tbody><tr><td colspan="6" class="loading">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Admin Panel View -->
    <div id="admin-view" class="view">
      <div id="admin-login-view">
        <div class="card" style="max-width: 500px; margin: 2rem auto;">
          <div class="card-header"><h2>Admin Authentication</h2></div>
          <div class="card-body">
            <p style="margin-bottom: 1rem; font-size: 0.875rem;">Access to processing features requires an API key.</p>
            <div class="api-key-input-group">
              <input type="password" id="admin-api-key-input" placeholder="Enter ADMIN_API_KEY...">
              <button class="btn" onclick="loginAdmin()">Login</button>
            </div>
            <p id="admin-login-error" style="color: var(--danger); font-size: 0.75rem; margin-top: 0.5rem; display: none;"></p>
          </div>
        </div>
      </div>

      <div id="admin-features-view" style="display: none;">
        <div class="card-header" style="background: white; border-radius: 8px 8px 0 0; margin-bottom: 1.5rem; border: 1px solid var(--border);">
          <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <h2 style="font-size: 1.25rem;">Admin</h2>
            <button class="btn btn-sm btn-outline" onclick="logoutAdmin()">Logout</button>
          </div>
        </div>

        <div id="active-jobs-panel" class="active-jobs-panel" style="display:none;">
          <h3><span class="spinner"></span> Active Scraper Jobs</h3>
          <div id="active-jobs-list" class="active-jobs-list"></div>
        </div>
        
        <!-- Instructions Panel -->
        <div class="card" style="border-left: 4px solid #3182ce; margin-bottom: 1.5rem;">
          <div class="card-header"><h2>ðŸ“‹ Data Ingestion Workflow</h2></div>
          <div class="card-body" style="font-size: 0.875rem;">
            <p style="margin-bottom: 1rem;"><strong>Initial Setup (one-time):</strong></p>
            <ol style="margin-left: 1.5rem; margin-bottom: 1rem;">
              <li><strong>NH CCIS</strong> - Run first to populate the master provider directory</li>
              <li><strong>TransparentNH Historical</strong> - Load all fiscal years (FY 2009-2026) ~30 min</li>
              <li><strong>USAspending</strong> - Fetch federal CCDF awards</li>
              <li><strong>Pattern Analysis</strong> - Run fraud detection</li>
            </ol>
            <p style="margin-bottom: 0.5rem;"><strong>Recurring Updates (automatic):</strong></p>
            <ul style="margin-left: 1.5rem; font-size: 0.8rem; color: var(--text-light);">
              <li>CCIS Provider Directory - Weekly (Friday 4 AM UTC)</li>
              <li>TransparentNH Current FY - Weekly (Saturday 3 AM UTC)</li>
              <li>USAspending - Daily (6 AM UTC)</li>
              <li>Fraud Analysis - Weekly (Monday 8 AM UTC)</li>
            </ul>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><h2>Data Scrapers & Ingestion</h2><button class="btn btn-sm btn-outline" onclick="refreshJobStatus()">Refresh Status</button></div>
          <div class="card-body">
            <div class="scraper-grid">
              <!-- CCIS Provider Directory -->
              <div class="scraper-card" id="card-ccis" style="border-left: 3px solid #805ad5;">
                <h4><span class="icon" style="background:#805ad5;color:white;">ðŸ‘¶</span>NH CCIS Provider Directory</h4>
                <p>Authoritative source of NH childcare providers. Run FIRST to populate provider_master table.</p>
                <div class="scraper-actions">
                  <button class="btn btn-sm" onclick="startCCISScraper()">Scrape CCIS</button>
                </div>
                <div class="scraper-progress" id="progress-ccis">
                  <div class="progress-bar-container"><div class="progress-bar"></div></div>
                  <div class="progress-status"><span class="spinner"></span><span class="status-text">Initializing...</span></div>
                </div>
              </div>

              <!-- TransparentNH Historical -->
              <div class="scraper-card" id="card-tnh-historical" style="border-left: 3px solid #d69e2e;">
                <h4><span class="icon" style="background:#d69e2e;color:white;">ðŸ“š</span>TransparentNH Historical</h4>
                <p>One-time ingestion of ALL fiscal years (FY 2009-2026). Takes ~30 minutes.</p>
                <div class="scraper-actions">
                  <button class="btn btn-sm" onclick="startTransparentNHHistorical()">Load All Years</button>
                </div>
                <div class="scraper-progress" id="progress-tnh-historical">
                  <div class="progress-bar-container"><div class="progress-bar"></div></div>
                  <div class="progress-status"><span class="spinner"></span><span class="status-text">Initializing...</span></div>
                </div>
              </div>

              <!-- TransparentNH Current Year -->
              <div class="scraper-card" id="card-tnh-current" style="border-left: 3px solid #38a169;">
                <h4><span class="icon" style="background:#38a169;color:white;">$</span>TransparentNH Current FY</h4>
                <p>Ingest current fiscal year expenditures. Updated throughout the year.</p>
                <div class="scraper-actions">
                  <button class="btn btn-sm" onclick="startTransparentNHCurrentYear()">Scrape FY 2026</button>
                </div>
                <div class="scraper-progress" id="progress-tnh-current">
                  <div class="progress-bar-container"><div class="progress-bar"></div></div>
                  <div class="progress-status"><span class="spinner"></span><span class="status-text">Initializing...</span></div>
                </div>
              </div>

              <!-- USAspending -->
              <div class="scraper-card" id="card-usaspending">
                <h4><span class="icon" style="background:#3182ce;color:white;">F</span>USAspending.gov (Federal)</h4>
                <p>Fetch federal CCDF grant awards to NH.</p>
                <div class="scraper-actions"><button class="btn btn-sm" onclick="startUSASpendingScraper()">Fetch Awards</button></div>
                <div class="scraper-progress" id="progress-usaspending">
                  <div class="progress-bar-container"><div class="progress-bar"></div></div>
                  <div class="progress-status"><span class="spinner"></span><span class="status-text">Initializing...</span></div>
                </div>
              </div>

              <!-- Pattern Analysis -->
              <div class="scraper-card" id="card-fraud">
                <h4><span class="icon" style="background:#e53e3e;color:white;">!</span>Pattern Analysis</h4>
                <p>Run fraud detection algorithms on all expenditure data.</p>
                <div class="scraper-actions"><button class="btn btn-sm" onclick="startFraudAnalysis()">Run Full Analysis</button></div>
                <div class="scraper-progress" id="progress-fraud">
                  <div class="progress-bar-container"><div class="progress-bar"></div></div>
                  <div class="progress-status"><span class="spinner"></span><span class="status-text">Initializing...</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="border-top: 4px solid var(--danger);">
          <div class="card-header"><h2>System Administration</h2></div>
          <div class="card-body">
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
              <div style="flex: 1; min-width: 250px; background: var(--bg); padding: 1rem; border-radius: 6px;">
                <h4 style="font-size: 0.875rem; margin-bottom: 0.5rem;">Database Maintenance</h4>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                  <button class="btn btn-sm btn-outline" onclick="confirmInitDb()" style="color: var(--danger); border-color: var(--danger);">Initialize / Reset Schema</button>
                </div>
              </div>
              <div style="flex: 1; min-width: 250px; background: var(--bg); padding: 1rem; border-radius: 6px;">
                <h4 style="font-size: 0.875rem; margin-bottom: 0.5rem;">System Information</h4>
                <button class="btn btn-sm btn-outline" onclick="viewDbInfo()">Check Connection</button>
                <div id="db-info-result" style="font-size: 0.7rem; margin-top: 0.5rem; max-height: 100px; overflow-y: auto;"></div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header"><h2>Ingestion & Job History</h2><button class="btn btn-sm btn-outline" onclick="loadIngestionHistory()">Refresh</button></div>
          <div class="card-body" style="overflow-x:auto;">
            <table id="ingestion-history-table">
              <thead><tr><th>Source</th><th>Status</th><th>Processed</th><th>Imported</th><th>Started</th><th>Details</th></tr></thead>
              <tbody id="ingestion-history-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Data Sources View -->
    <div id="sources-view" class="view">
      <div class="card">
        <div class="card-header"><h2>Data Sources</h2></div>
        <div class="card-body"><div class="data-sources" id="data-sources-list"></div></div>
      </div>
    </div>
  </main>
  
  <div id="provider-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h3 id="provider-modal-title">Provider Details</h3><button class="modal-close" onclick="closeModal('provider-modal')">&times;</button></div>
      <div class="modal-body" id="provider-modal-body"></div>
    </div>
  </div>
  
  <script>
    const API_BASE = '/api';
    let cityChart, fraudChart;
    let activeTriggerPollers = {};
    
    window.onload = () => { 
      loadDashboard(); 
      // Initial view based on hash or default to dashboard
      const initialView = window.location.hash.slice(1) || 'dashboard';
      showView(initialView);
      checkAdminStatus(); 
    };

    window.onhashchange = () => {
      const viewName = window.location.hash.slice(1) || 'dashboard';
      showView(viewName);
    };
    
    function getApiKey() { return localStorage.getItem('nh-tracker-api-key') || ''; }
    function loginAdmin() {
      const key = document.getElementById('admin-api-key-input').value;
      if (!key) { alert('Enter key'); return; }
      localStorage.setItem('nh-tracker-api-key', key);
      checkAdminStatus();
    }
    function logoutAdmin() { localStorage.removeItem('nh-tracker-api-key'); checkAdminStatus(); }
    function checkAdminStatus() {
      const key = getApiKey();
      const loginView = document.getElementById('admin-login-view');
      const featuresView = document.getElementById('admin-features-view');
      if (loginView) loginView.style.display = key ? 'none' : 'block';
      if (featuresView) featuresView.style.display = key ? 'block' : 'none';
      if (key) { loadIngestionHistory(); refreshJobStatus(); }
    }
    function getAuthHeaders() { return { 'Content-Type': 'application/json', 'x-api-key': getApiKey() }; }

    // Progress bar helpers
    function showProgress(cardId, statusText = 'Initializing...') {
      const progress = document.getElementById(`progress-${cardId}`);
      if (progress) {
        progress.classList.add('active');
        const bar = progress.querySelector('.progress-bar');
        bar.classList.remove('complete', 'error');
        updateProgressStatus(cardId, statusText);
      }
    }

    function updateProgressStatus(cardId, statusText) {
      const progress = document.getElementById(`progress-${cardId}`);
      if (progress) {
        const text = progress.querySelector('.status-text');
        if (text) text.textContent = statusText;
      }
    }

    function completeProgress(cardId, statusText = 'Complete!', isError = false) {
      const progress = document.getElementById(`progress-${cardId}`);
      if (progress) {
        const bar = progress.querySelector('.progress-bar');
        const spinner = progress.querySelector('.spinner');
        bar.classList.add(isError ? 'error' : 'complete');
        if (spinner) spinner.style.display = 'none';
        updateProgressStatus(cardId, statusText);
        // Hide after 5 seconds
        setTimeout(() => {
          progress.classList.remove('active');
          if (spinner) spinner.style.display = '';
        }, 5000);
      }
    }

    function hideProgress(cardId) {
      const progress = document.getElementById(`progress-${cardId}`);
      if (progress) progress.classList.remove('active');
    }

    document.querySelectorAll('nav a').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const viewName = e.target.dataset.view;
        window.location.hash = viewName;
      });
    });
    
    function showView(viewName) {
      const validViews = ['dashboard', 'providers', 'payments', 'fraud', 'sources', 'admin'];
      if (!validViews.includes(viewName)) return;

      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById(`${viewName}-view`).classList.add('active');
      
      document.querySelectorAll('nav a').forEach(a => {
        a.classList.toggle('active', a.getAttribute('data-view') === viewName);
      });

      switch(viewName) {
        case 'dashboard': loadDashboard(); break;
        case 'providers': loadProviders(); break;
        case 'payments': loadPayments(); break;
        case 'fraud': loadFraud(); break;
        case 'sources': loadDataSources(); loadSourceTables(); break;
      }
      
      if (viewName === 'admin') checkAdminStatus();
      
      // Trigger data loading for specific views if not already loaded
      switch(viewName) {
        case 'providers': loadProviders(); break;
        case 'payments': loadPayments(); break;
        case 'fraud': loadFraudIndicators(); break;
        case 'sources': loadDataSources(); loadSourceTables(); break;
      }
    }
    
    let sourceTableState = {
      page: 1,
      limit: 20,
      filters: {}
    };

    async function loadSourceTables() {
      const key = getApiKey();
      if (!key) {
        const select = document.getElementById('source-table-select');
        if (select) select.innerHTML = '<option value="">Admin Login Required</option>';
        return;
      }
      try {
        const res = await fetch(`${API_BASE}/admin/sources`, { headers: getAuthHeaders() });
        if (!res.ok) {
          const err = await res.json().catch(() => ({ error: res.statusText }));
          throw new Error(err.error || `HTTP ${res.status}`);
        }
        const data = await res.json();
        const select = document.getElementById('source-table-select');
        if (!data.tables || data.tables.length === 0) {
          select.innerHTML = '<option value="">No source tables found</option>';
          return;
        }
        select.innerHTML = '<option value="">Select a source table...</option>' +
          data.tables.map(t => `<option value="${t}">${t}</option>`).join('');
      } catch (e) {
          console.error(e);
          document.getElementById('source-table-select').innerHTML = '<option value="">Error: ' + (e.message || 'Failed to load') + '</option>';
      }
    }

    function updateSourceFilter(column, value) {
      sourceTableState.filters[column] = value;
      sourceTableState.page = 1; // Reset to page 1 on filter change
      loadSourceTableData();
    }

    function changeSourcePage(delta) {
      sourceTableState.page += delta;
      loadSourceTableData();
    }

    function renderPagination(p) {
      return `
        <div class="pagination">
          <button class="btn btn-sm btn-outline" ${p.currentPage <= 1 ? 'disabled' : ''} onclick="changeSourcePage(-1)">Previous</button>
          <span style="font-size:0.875rem;">Page <strong>${p.currentPage}</strong> of <strong>${p.totalPages}</strong> (${p.totalCount} total records)</span>
          <button class="btn btn-sm btn-outline" ${p.currentPage >= p.totalPages ? 'disabled' : ''} onclick="changeSourcePage(1)">Next</button>
        </div>
      `;
    }

    async function loadSourceTableData(reset = false) {
      const table = document.getElementById('source-table-select').value;
      if (!table) return;
      
      const limitSelect = document.getElementById('source-table-limit');
      sourceTableState.limit = parseInt(limitSelect.value, 10);

      if (reset) {
        sourceTableState.page = 1;
        sourceTableState.filters = {};
      }

      const container = document.getElementById('source-table-container');
      const paginationTop = document.getElementById('source-table-pagination-top');
      const paginationBottom = document.getElementById('source-table-pagination-bottom');
      const wrapper = document.getElementById('source-table-scroll-wrapper');
      const topScroll = document.getElementById('source-top-scrollbar');
      const topScrollContent = document.getElementById('source-top-scrollbar-content');

      // Loading state
      wrapper.innerHTML = '<p style="text-align:center;padding:2rem;"><span class="spinner"></span> Loading data...</p>';
      paginationTop.innerHTML = '';
      paginationBottom.innerHTML = '';
      topScroll.style.display = 'none';
      
      try {
        const queryParams = new URLSearchParams({
          page: sourceTableState.page,
          limit: sourceTableState.limit
        });
        
        Object.keys(sourceTableState.filters).forEach(col => {
          if (sourceTableState.filters[col]) {
            queryParams.append(`filter_${col}`, sourceTableState.filters[col]);
          }
        });

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout

        let res;
        try {
          res = await fetch(`${API_BASE}/admin/sources/${table}?${queryParams.toString()}`, {
            headers: getAuthHeaders(),
            signal: controller.signal
          });
        } finally {
          clearTimeout(timeoutId);
        }

        if (!res.ok) {
          const err = await res.json().catch(() => ({ error: res.statusText }));
          throw new Error(err.error || `HTTP ${res.status}`);
        }
        const data = await res.json();

        if (!data.rows) {
          throw new Error(data.error || 'No data returned from server');
        }

        if (data.rows.length === 0 && sourceTableState.page === 1 && Object.keys(sourceTableState.filters).length === 0) {
          wrapper.innerHTML = '<p style="text-align:center;padding:2rem;">No records found in this table.</p>';
          return;
        }
        
        const cols = data.rows.length > 0 ? Object.keys(data.rows[0]) : Object.keys(sourceTableState.filters);
        const p = data.pagination;
        const paginationHtml = renderPagination(p);
        
        paginationTop.innerHTML = paginationHtml;
        paginationBottom.innerHTML = paginationHtml;

        let tableHtml = '<table><thead><tr>';
        cols.forEach(c => {
          tableHtml += `
            <th>
              <div class="header-content">
                <span>${c}</span>
                <input type="text" class="filter-input" placeholder="Filter..." 
                  value="${sourceTableState.filters[c] || ''}" 
                  onkeyup="if(event.key==='Enter') updateSourceFilter('${c}', this.value)"
                  onblur="updateSourceFilter('${c}', this.value)">
              </div>
            </th>`;
        });
        tableHtml += '</tr></thead><tbody>';
        
        if (data.rows.length === 0) {
          tableHtml += `<tr><td colspan="${cols.length}" style="text-align:center;padding:2rem;color:var(--text-light);">No results matching your filters.</td></tr>`;
        } else {
          tableHtml += data.rows.map(row => `<tr>${cols.map(c => `<td>${row[c] || ''}</td>`).join('')}</tr>`).join('');
        }
        tableHtml += '</tbody></table>';
        wrapper.innerHTML = tableHtml;

        // Sync Top Scrollbar
        setTimeout(() => {
          const tableEl = wrapper.querySelector('table');
          if (tableEl && tableEl.offsetWidth > wrapper.offsetWidth) {
            topScroll.style.display = 'block';
            topScrollContent.style.width = tableEl.offsetWidth + 'px';
            
            // Link scroll positions
            topScroll.onscroll = () => { wrapper.scrollLeft = topScroll.scrollLeft; };
            wrapper.onscroll = () => { topScroll.scrollLeft = wrapper.scrollLeft; };
          } else {
            topScroll.style.display = 'none';
          }
        }, 100);

      } catch (e) {
        const msg = e.name === 'AbortError' ? 'Request timed out. The server may be slow or unavailable.' : e.message;
        wrapper.innerHTML = `<p style="color:var(--danger);padding:2rem;">Error: ${msg}</p>`;
      }
    }

    async function loadDataSources() {
      const container = document.getElementById('data-sources-list');
      container.innerHTML = '<div class="loading">Loading data sources...</div>';
      try {
        const res = await fetch(`${API_BASE}/data-sources`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (!data.sources || data.sources.length === 0) {
          container.innerHTML = '<p style="color:var(--text-light);">No data sources configured.</p>';
          return;
        }
        container.innerHTML = data.sources.map(s => `
          <div class="source-card">
            <h4>${s.name}</h4>
            <p style="font-size:0.8rem; margin-bottom:0.5rem;">${s.description}</p>
            <div style="font-size:0.75rem; color:var(--text-light);">
              <div style="margin-bottom:0.25rem;"><strong>URL:</strong> <a href="${s.url}" target="_blank">${s.url}</a></div>
              <div><strong>Update Frequency:</strong> ${s.frequency}</div>
              <div><strong>Last Updated:</strong> ${s.last_updated ? new Date(s.last_updated).toLocaleDateString() : 'Never'}</div>
            </div>
          </div>
        `).join('');
      } catch (e) {
        container.innerHTML = `<div class="error">Failed to load data sources: ${e.message}</div>`;
      }
    }

    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    
    function formatCurrency(v) { return '$' + Number(v||0).toLocaleString(); }
    function formatMonth(y, m) { return m ? ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][m-1] + ' ' + y : '-'; }
    function severityBadge(s) { return `<span class="badge badge-${s||'low'}">${(s||'low').toUpperCase()}</span>`; }
    function statusBadge(s) { return `<span class="badge badge-${s||'open'}">${s||'open'}</span>`; }
    function capacityStatus(ch, c) { return ch > c ? `<span class="capacity-warning">OVER</span>` : `<span style="color:var(--success)">${ch||0}/${c||0}</span>`; }

    async function loadDashboard() {
      try {
        const [dashRes, federalRes] = await Promise.all([fetch(`${API_BASE}/dashboard`), fetch(`${API_BASE}/federal/summary`)]);
        const data = await dashRes.json();
        const fed = await federalRes.json();
        renderFederalFunding(fed);
        document.getElementById('stats-grid').innerHTML = `<div class="stat-card"><h3>Total Providers</h3><div class="value">${data.total_providers}</div></div><div class="stat-card"><h3>CCDF Payments</h3><div class="value">${formatCurrency(data.total_payments)}</div></div><div class="stat-card"><h3>Fraud Flags</h3><div class="value">${data.fraud_indicators_count}</div></div>`;
        document.querySelector('#top-providers tbody').innerHTML = data.top_providers.map(p => `<tr><td class="clickable" onclick="showProviderDetail(${p.id})">${p.canonical_name}</td><td>${p.city}</td><td>${p.provider_type}</td><td>${p.capacity}</td><td class="amount">${formatCurrency(p.total_payments)}</td><td>${p.fraud_count}</td></tr>`).join('');
      } catch (e) { console.error(e); }
    }

    function renderFederalFunding(fed) {
      document.getElementById('federal-funding-content').innerHTML = `<div>Total: ${formatCurrency(fed.totalFederalAmount)} | Awards: ${fed.totalAwards}</div>`;
    }

    async function refreshFederalData() {
      await fetch(`${API_BASE}/federal/awards?refresh=true`, { headers: getAuthHeaders() });
      loadDashboard();
    }

    async function loadProviders() {
      const res = await fetch(`${API_BASE}/providers`);
      const data = await res.json();
      document.querySelector('#providers-table tbody').innerHTML = data.map(p => `<tr><td class="clickable" onclick="showProviderDetail(${p.id})">${p.canonical_name}</td><td>${p.city}</td><td>${p.provider_type}</td><td>${p.capacity}</td><td>${formatCurrency(p.total_payments || 0)}</td><td>${p.fraud_count || 0}</td></tr>`).join('');
    }

    async function showProviderDetail(id) {
      const res = await fetch(`${API_BASE}/providers/${id}`);
      const p = await res.json();
      const content = `
        <div class="provider-detail">
          <h2>${p.canonical_name}</h2>
          <div class="grid">
            <div>
              <p><strong>City:</strong> ${p.city}</p>
              <p><strong>Type:</strong> ${p.provider_type}</p>
              <p><strong>Capacity:</strong> ${p.capacity}</p>
            </div>
            <div>
              <p><strong>CCDF ID:</strong> ${p.ccis_provider_id}</p>
              <p><strong>Quality:</strong> ${p.quality_rating || 'N/A'}</p>
              <p><strong>Active:</strong> ${p.is_active ? 'Yes' : 'No'}</p>
            </div>
          </div>
          <h3>Payments</h3>
          <table><thead><tr><th>Date</th><th>Amount</th><th>Source</th></tr></thead><tbody>${p.payments.map(pay => `<tr><td>${pay.payment_date}</td><td>${formatCurrency(pay.amount)}</td><td>${pay.funding_source}</td></tr>`).join('')}</tbody></table>
        </div>
      `;
      // showModal(content);
      openModal('provider-modal');
      document.getElementById('provider-modal-title').textContent = p.name_display || p.canonical_name;
      document.getElementById('provider-modal-body').innerHTML = content;
    }

    /*
    async function showProviderDetail(id) {
      openModal('provider-modal');
      const res = await fetch(`${API_BASE}/providers/${id}`);
      const p = await res.json();
      document.getElementById('provider-modal-title').textContent = p.name;
      document.getElementById('provider-modal-body').innerHTML = `<div class="detail-grid"><div><label>City</label>${p.city}</div><div><label>Payments</label>${formatCurrency(p.total_payments)}</div></div>`;
    }
    */

    async function loadIngestionHistory() {
      const res = await fetch(`${API_BASE}/ingestion/runs`, { headers: getAuthHeaders() });
      const data = await res.json();
      document.getElementById('ingestion-history-body').innerHTML = (data.runs || []).map(r => `<tr><td>${r.source}</td><td>${r.status}</td><td>${r.records_processed}</td><td>${r.records_imported}</td><td>${new Date(r.started_at).toLocaleString()}</td><td><button onclick='alert(JSON.stringify(${JSON.stringify(r.details)}))'>View</button></td></tr>`).join('');
    }

    let currentRunId = null;

    async function refreshJobStatus() {
      try {
        const res = await fetch(`${API_BASE}/trigger/runs`, { headers: getAuthHeaders() });
        if (!res.ok) return;
        const data = await res.json();
        const runs = data.runs || [];

        // Check specific run status if we are tracking one
        if (currentRunId) {
          // Fetch detailed run info with metadata
          try {
            const runRes = await fetch(`${API_BASE}/trigger/runs/${currentRunId}`, { headers: getAuthHeaders() });
            if (runRes.ok) {
              const run = await runRes.json();
              const meta = run.metadata || {};
              const progress = meta.progress || 0;
              const status = meta.status || run.status;

              // Update progress bar width
              const progressBar = document.querySelector('#progress-ccis .progress-bar');
              if (progressBar) {
                progressBar.style.width = `${progress}%`;
              }

              // Update status text
              if (meta.status) {
                updateProgressStatus('ccis', meta.status);
              }

              const runStatus = (run.status || '').toUpperCase();
              if (runStatus === 'COMPLETED') {
                const finalStatus = meta.status || `Done! ${run.output?.totalFound || ''} providers updated`;
                completeProgress('ccis', finalStatus);
                currentRunId = null;
              } else if (runStatus === 'FAILED' || runStatus === 'CANCELED') {
                completeProgress('ccis', meta.status || `Job ${run.status}`, true);
                currentRunId = null;
              }
            }
          } catch (e) {
            // Fall back to list-based tracking
            const run = runs.find(r => r.id === currentRunId);
            if (run) {
              const runStatus = (run.status || '').toUpperCase();
              if (runStatus === 'COMPLETED') {
                completeProgress('ccis', 'Job Completed Successfully!');
                currentRunId = null;
              } else if (runStatus === 'FAILED' || runStatus === 'CANCELED') {
                completeProgress('ccis', `Job ${run.status}`, true);
                currentRunId = null;
              }
            }
          }
        }

        const active = runs.filter(r => ['EXECUTING','PENDING', 'QUEUED', 'REATTEMPTING'].includes((r.status || '').toUpperCase()));

        currentActiveJob = active.length > 0 ? active[0] : null;

        // Update active jobs panel
        const panel = document.getElementById('active-jobs-panel');
        if (panel) {
          panel.style.display = currentActiveJob ? 'block' : 'none';
          document.getElementById('active-jobs-list').innerHTML = active.map(r => {
            const meta = r.metadata || {};
            const progress = meta.progress || (r.status === 'EXECUTING' ? 50 : 10);
            const statusText = meta.status || r.status;
            return `
            <div class="active-job-item">
              <div style="display:flex; justify-content:space-between; margin-bottom:0.5rem;">
                <strong>${r.taskIdentifier}</strong>
                <span class="badge">${r.status}</span>
              </div>
              <div class="progress-bar-bg">
                <div class="progress-bar-fill" style="width: ${progress}%"></div>
              </div>
              <div style="font-size:0.75rem; color:rgba(255,255,255,0.9); margin-top:0.25rem;">${statusText}</div>
              <div style="font-size:0.7rem; color:rgba(255,255,255,0.6)">Started: ${new Date(r.createdAt).toLocaleString()}</div>
            </div>
          `}).join('');
        }

        // Disable/Enable trigger buttons
        const triggerButtons = document.querySelectorAll('.scraper-card button, .card-header button[onclick^="start"]');
        const isAnyActive = active.length > 0;

        triggerButtons.forEach(btn => {
          btn.disabled = isAnyActive;
          if (isAnyActive) {
            btn.style.opacity = '0.5';
            btn.style.cursor = 'not-allowed';
          } else {
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
          }
        });

        // Polling if active or if we are tracking a specific run that might have finished but we haven't seen it yet
        if (isAnyActive || currentRunId) {
          setTimeout(refreshJobStatus, 2000); // Poll every 2 seconds for better responsiveness
        }
      } catch (e) { console.error('Job status refresh failed:', e); }
    }

    async function safeTrigger(taskFn, ...args) {
      if (currentActiveJob) {
        alert('A background task is already running. Please wait for it to complete.');
        return;
      }
      
      // Immediately disable buttons to prevent double-click
      const triggerButtons = document.querySelectorAll('.scraper-card button, .card-header button[onclick^="start"]');
      triggerButtons.forEach(btn => {
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
      });

      try {
        await taskFn(...args);
      } catch (e) {
        alert('Task failed to start: ' + e.message);
        refreshJobStatus();
      }
    }

    // ... (rest of functions)

    async function startCCISScraper() {
      showProgress('ccis', 'Connecting to CCIS portal...');
      await safeTrigger(async () => {
        updateProgressStatus('ccis', 'Scraping provider directory...');
        const res = await fetch(`${API_BASE}/trigger/ccis`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({})
        });
        if (!res.ok) {
          const err = await res.json();
          completeProgress('ccis', err.error || 'Failed', true);
          throw new Error(err.error || 'Failed to start CCIS scraper');
        }
        const data = await res.json();
        
        // When running in Trigger.dev, the initial response just gives us the Run ID
        if (data.runId) {
          currentRunId = data.runId; // Track this run
          updateProgressStatus('ccis', `Job Queued (Run ID: ${data.runId.slice(0,8)}...)`);
        } else {
          // Fallback for local execution/direct results
          const count = data.result?.providersImported || 'unknown';
          completeProgress('ccis', `Done! ${count} providers imported`);
        }
        
        refreshJobStatus();
      });
    }

    async function startTransparentNHHistorical() {
      if (!confirm('This will download ALL fiscal years (FY 2009-2026). This takes ~30 minutes. Continue?')) return;
      showProgress('tnh-historical', 'Starting historical ingestion...');
      await safeTrigger(async () => {
        updateProgressStatus('tnh-historical', 'Downloading 18 fiscal years...');
        const res = await fetch(`${API_BASE}/trigger/transparent-nh-historical`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({})
        });
        if (!res.ok) {
          const err = await res.json();
          completeProgress('tnh-historical', err.error || 'Failed', true);
          throw new Error(err.error || 'Failed to start historical ingestion');
        }
        const data = await res.json();
        const years = data.result?.length || 0;
        completeProgress('tnh-historical', `Done! ${years} fiscal years processed`);
        refreshJobStatus();
      });
    }

    async function startTransparentNHCurrentYear() {
      showProgress('tnh-current', 'Downloading FY 2026 data...');
      await safeTrigger(async () => {
        updateProgressStatus('tnh-current', 'Processing expenditure records...');
        const res = await fetch(`${API_BASE}/trigger/transparent-nh-current`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({})
        });
        if (!res.ok) {
          const err = await res.json();
          completeProgress('tnh-current', err.error || 'Failed', true);
          throw new Error(err.error || 'Failed to start current year ingestion');
        }
        const data = await res.json();
        const records = data.result?.childcareRecords || 0;
        completeProgress('tnh-current', `Done! ${records.toLocaleString()} records`);
        refreshJobStatus();
      });
    }

    async function startUSASpendingScraper() {
      showProgress('usaspending', 'Fetching federal awards...');
      await safeTrigger(async () => {
        updateProgressStatus('usaspending', 'Querying USAspending API...');
        const res = await fetch(`${API_BASE}/trigger/usaspending`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({})
        });
        if (!res.ok) {
          const err = await res.json();
          completeProgress('usaspending', err.error || 'Failed', true);
          throw new Error(err.error || 'Failed to start USAspending scraper');
        }
        const data = await res.json();
        // Trigger.dev v3 returns runId
        if (data.runId) {
            updateProgressStatus('usaspending', `Job Queued (Run ID: ${data.runId.slice(0,8)}...)`);
        } else {
            completeProgress('usaspending', 'Done! Awards updated.');
        }
        refreshJobStatus();
      });
    }

    async function startFraudAnalysis() {
      showProgress('fraud', 'Starting pattern analysis...');
      await safeTrigger(async () => {
        updateProgressStatus('fraud', 'Running fraud detection algorithms...');
        const res = await fetch(`${API_BASE}/trigger/fraud-analysis`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({})
        });
        if (!res.ok) {
          const err = await res.json();
          completeProgress('fraud', err.error || 'Failed', true);
          throw new Error(err.error || 'Failed to start fraud analysis');
        }
        const data = await res.json();
        // Trigger.dev v3 returns runId
        if (data.runId) {
            updateProgressStatus('fraud', `Job Queued (Run ID: ${data.runId.slice(0,8)}...)`);
        } else {
            const count = data.result?.flagsGenerated || 0;
            completeProgress('fraud', `Done! ${count} flags generated`);
        }
        refreshJobStatus();
      });
    }

    async function confirmInitDb() { if (prompt('Type RESET:')==='RESET') await fetch(`${API_BASE}/admin/init-db`, { method: 'POST', headers: getAuthHeaders() }); }
    async function seedSampleData() { await fetch(`${API_BASE}/admin/seed-sample-data`, { method: 'POST', headers: getAuthHeaders() }); }
    async function viewDbInfo() {
      const url = `${API_BASE}/admin/db-info`;
      console.log(`Checking connection to: ${url}`);
      const el = document.getElementById('db-info-result');
      if (!el) return console.error('db-info-result element not found');
      el.innerHTML = 'Connecting...';
      try {
        const headers = getAuthHeaders();
        console.log('Using headers:', Object.keys(headers).join(', '));
        
        const res = await fetch(url, { headers });
        console.log('Response status:', res.status);
        console.log('Response content-type:', res.headers.get('content-type'));
        
        const contentType = res.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || data.message || `HTTP ${res.status}`);
          el.innerHTML = `<pre style="font-size:0.6rem;background:#eee;padding:0.5rem;border-radius:4px;overflow:auto;max-height:200px;">${JSON.stringify(data,null,2)}</pre>`;
        } else {
          const text = await res.text();
          console.error('Non-JSON response (first 500 chars):', text.slice(0, 500));
          throw new Error(`Server returned HTML instead of JSON (HTTP ${res.status}). This usually means the API route was not found and the server returned a 404 page. Check the console for more info.`);
        }
      } catch (e) {
        console.error('Connection check error:', e);
        el.innerHTML = `<div style="color:var(--danger);font-size:0.75rem;margin-top:0.5rem;padding:0.5rem;background:#fff5f5;border:1px solid #feb2b2;border-radius:4px;">${e.message}</div>`;
      }
    }
  </script>
</body>
</html>
